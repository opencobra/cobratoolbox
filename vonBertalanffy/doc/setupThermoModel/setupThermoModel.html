<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of setupThermoModel</title>
  <meta name="keywords" content="setupThermoModel">
  <meta name="description" content="Thermodynamically constrains a COBRA model.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<!-- menu.html setupThermoModel -->
<h1>setupThermoModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Thermodynamically constrains a COBRA model.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [modelT,directions,solutionThermoRecon]=setupThermoModel(model,metAbbrAlbertyAbbr,metGroupCont,Alberty2006,computedSpeciesData,temp,PHA,IS,CHI,biomassRxnAbbr,rxnAbbrDatabaseID,defaultMetBounds,metBoundsFile,rxnBoundsFile,Legendre,useKeqData,nStdDevGroupCont,cumNormProbCutoff,figures,printToFile,secondPassAssignment) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Thermodynamically constrains a COBRA model.

 This function takes as imput an ordinary COBRA model (such as from sbml.xml)
 then uses thermodynamic data to setup a thermodynamic COBRA model.

INPUT
 model
 model.biomassRxnAbbr      abbreviation of biomass reaction

 Alberty2006  Basic data on the metabolite species that make
              up a reactant, compiled by Robert A. Alberty,
              Massachusetts Institute of Technology.
              In Print: Robert A. Alberty, Biochemical Thermodynamics: 
              Applications of Mathematica. John Wiley &amp; Sons, 2006. p391-395
              Online: BasicBioChemData3.nb
              http://library.wolfram.com/infocenter/MathSource/5704/
              Only species of interest in the range pH 5 to 9 are included.

 Alberty2006 is a structure with two fields for each metabolite:
 Alberty2006.abbreviation(i) Alberty reactant abbreviation
 Alberty2006.basicData(i) cell array with 4 columns: dGf0,dHf0,charge,#Hydrogens 

 metAbbrAlbertyAbbr    mapping from model metabolite primary key to
                       primary key of reactants in Alberty2006

 metGroupCont  Group contribution data, derived by submitting metabolite 
               .mol files to the web based implementation, as described in:
               M. D. Jankowski, C. S. Henry, L. J. Broadbelt, and V. Hatzimanikatis.
               Group contribution method for thermodynamic analysis of complex metabolic networks. 
               Biophys J, 95(3):1487-1499, Aug 2008.
 
 computedSpeciesData   Structure with the same format as Alberty2006.
                       Basic data on metabolite species computed from group contribution data
                       and pKas estimated with ChemAxon's pKa calculator
                       plugin. Optional ([] if not available). Overwrites
                       data from metGroupCont if available. - Hulda
 
 metGroupCont has the following fields
 metGroupCont(m).abbreviation                      metabolite abbreviation
 metGroupCont(m).delta_G_formation                 estimate of standard Gibbs energy of formation    
 metGroupCont(m).delta_G_formation_uncertainty     standard error in estimate of standard Gibbs energy of formation
 metGroupCont(m).formulaMarvin                     metabolite formula of molfile (Marvin)
 metGroupCont(m).chargeMarvin                      metabolite charge of molfile (Marvin)
 metGroupCont(m).groupContribution_pH              glass electrode pH of metabolite molfile
 metGroupCont(m).groupContribution_file            fileName with origin of group contribution data

 temp              temperature 298.15 K to 313.15 K

 PHA.*             glass electrode pH, between 5-9, in compartment defined by letter *
                   *   compartment
                   c   cytoplasm
                   p   periplasm
                   e   extracellular environment
                   m   mitochondria
                   n   nucleus
                   r   endoplasmic reticulum
                   g   Golgi apparatus
                   l   lysosome
                   x   peroxisome

 IS.*              ionic strength (0 - 0.35M) in compartment defined by letter *
 
 CHI.*             electrical potential (mV) in compartment defined byletter *

 rxnAbbrDatabaseID   n x 2 cell array of reaction abbreviation and
                     corresponding database ID
 
 defaultMetBounds.*  Default bounds on metabolite concentrations in mol/L. Used for
                     all metabolites except those listed in metBoundsFile.
                     - Hulda
                     *    ub or lb
                     ub   upper bound
                     lb   lower bound


 OPTIONAL INPUT

 metBoundsFile     filename with upper &amp; lower bounds on metabolite 
                   concentrations (Molar)
                   See 'model_met_bounds.txt' for format required
 rxnBoundsFile     filename with upper &amp; lower bounds on fluxes 
                   (mmol gDw-1 hr-1)
                   See 'model_rxn_bounds.txt' for format required

 Legendre              {(1),0} Legendre Transformation of dGf0?
 useKeqData            {(1),0} Use dGf0 back calculated from Keq?
 nStdDevGroupCont      {1} number of standard deviations of group contribution
                       uncertainty to be used for each metabolite
 cumNormProbCutoff     {0.1} positive real number between 0 and 0.5 that
                       specifies to tolerance when there is uncertainty in group
                       contribution estimates.
 figures               {0}, 1 = create figures
 printToFile           {0}, 1 = print out to log files
 secondPassAssignment  {0}, 1 = assign reaction directions based on the P(\Delta_{r}G^{\primeo}&lt;0)
                       that calculates the probability of a reaction being irreversible, given 
                       the available thermodynamic data.
                       Doing so may prevent the model from growing, therefore at this stage it
                       is necessary to manually adjust some of the reaction directionalities
                       such that the model can grow, and grow at a similar rate as observed in
                       vivo. Therefore this script cannot be made model invariant as there is an
                       essential manual debugging stage. 
                       A script is provided for E. coli iAF1260:
                       setThermoReactionDirectionalityiAF1260.m

OUTPUT
 modelT        a thermodynamic constraints based model

 modelT.gasConstant       Gas Constant
 modelT.faradayConstant   Faraday Constant
 modelT.temp              Temp

 modelT.met(m).dGft0                standard transformed Gibbs energy of formation(kJ/mol)
 modelT.met(m).dGft0Source          origin of data, Keq or groupContFileName.txt 
 modelT.met(m).dGft0Keq             standard transformed Gibbs energy of formation(kJ/mol) 
 modelT.met(m).dGft0GroupCont            group. cont. estimate of standard transformed Gibbs energy of formation(kJ/mol)
 modelT.met(m).dGf0GroupCont             group. cont. estimate of standard Gibbs energy of formation(kJ/mol)
 modelT.met(m).dGf0GroupContUncertainty  group. cont. uncertainty in estimate of standard Gibbs energy of formation (kJ/mol) 
 modelT.met(m).mf           mole fraction of each species within a pseudoisomer group
 modelT.met(m).aveZi        average charge
 modelT.met(m).chi          electrical potential
 modelT.met(m).aveHbound    average number of protons bound to a reactant

 modelT.lb_reconThermo      lower bound from amalgamation of reconstruction
                            and thermodynamic assignment directions
 modelT.ub_reconThermo      upper bound from amalgamation of reconstruction
                            and thermodynamic assignment directions

 directions    a structue of boolean vectors with different directionality 
               assignments where some vectors contain subsets of others

 qualitatively assigned directions 
       directions.fwdReconBool
       directions.revReconBool
       directions.reversibleReconBool

 qualitatively assigned directions using thermo in preference to
 qualitative assignments but using qualitative assignments where
 thermodynamic data is lacking
       directions.fwdReconThermoBool
       directions.revReconThermoBool
       directions.reversibleReconThermoBool

 reactions that are qualitatively assigned by thermodynamics
       directions.fwdThermoOnlyBool
       directions.revThermoOnlyBool
       directions.reversibleThermoOnlyBool

 qualtiative -&gt; quantiative changed reaction directions 
       directions.ChangeReversibleFwd
       directions.ChangeReversibleRev
       directions.ChangeForwardReverse
       directions.ChangeForwardReversible

 subsets of forward qualtiative -&gt; reversible quantiative change
   directions.ChangeForwardReversible_dGfKeq
   directions.ChangeForwardReversibleBool_dGfGC
   directions.ChangeForwardReversibleBool_dGfGC_byConcLHS
   directions.ChangeForwardReversibleBool_dGfGC_byConcRHS
   directions.ChangeForwardReversibleBool_dGfGC_bydGt0
   directions.ChangeForwardReversibleBool_dGfGC_bydGt0LHS
   directions.ChangeForwardReversibleBool_dGfGC_bydGt0Mid
   directions.ChangeForwardReversibleBool_dGfGC_bydGt0RHS
   directions.ChangeForwardReversibleBool_dGfGC_byConc_No_dGt0ErrorLHS
   directions.ChangeForwardReversibleBool_dGfGC_byConc_No_dGt0ErrorRHS

       directions.cumNormProbCutoff
       directions.ChangeForwardForwardBool_dGfGC

 solutionThermoRecon       FBA solution with thermodynamic in preference to 
                           reconstruction directions 
                           (see setThermoReactionDirectionality.m)

 DEPENDENCIES ON OTHER COBRA TOOLBOX FUNCTIONS
 findRxnIDs.m
 printRxnFormula.m

 OPTIONAL DEPENDENCIES ON OTHER PACKAGES (i.e. more accurate)
 Multiple Precision Toolbox for MATLAB by Ben Barrowes (mptoolbox_1.1)
 http://www.mathworks.com/matlabcentral/fileexchange/6446

 COBRA TOOLBOX solvers e.g. solveCobraLP.m and solveCobraLPCPLEX.m for
 conflict resolution for an infeasible LP.

 This code is part of the vonBertalanffy package for Systems Biothermodynamics.
 Ludwig von Bertalanffy
 http://en.wikipedia.org/wiki/Ludwig_von_Bertalanffy

 Ronan M.T. Fleming, Sept 2010.
 Hulda SH, Dec 2010    Added computedSpeciesData as input. Passed into
                       assignThermoToModel for calculation of transformed Gibbs energies of
                       formation.
 Hulda SH, Feb 2011    Made minor changes to some of the subfunctions.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../setupThermoModel/alberty/moleFractionStats.html" class="code" title="function moleFractionStats(modelT)">moleFractionStats</a>	Plots of mole fraction statistics.</li><li><a href="../setupThermoModel/alberty/realpH.html" class="code" title="function [pHr,pHAdjustment]=realpH(pHa,temp,is)">realpH</a>	Apparent glass electrode pH is not the same as real pH for thermodynamic calculations.</li><li><a href="../setupThermoModel/alberty/setCommonZeroStandardGibbsEnergyOfFormation.html" class="code" title="function model=setCommonZeroStandardGibbsEnergyOfFormation(model)">setCommonZeroStandardGibbsEnergyOfFormation</a>	Set all Alberty's cofactor metabolites to have a common thermodynamic baseline.</li><li><a href="../setupThermoModel/alberty/thermodynamicAdjustmentToStoichiometry.html" class="code" title="function model=thermodynamicAdjustmentToStoichiometry(model)">thermodynamicAdjustmentToStoichiometry</a>	Thermodynamic adjustments to the stoichiometric matrix for co2, h2o, and bound cofactors.</li><li><a href="../setupThermoModel/database/mapDatabaseID.html" class="code" title="function model=mapDatabaseID(model,rxnAbbrDatabaseID)">mapDatabaseID</a>	Map a set of reaction Database ID's to the model</li><li><a href="../setupThermoModel/directionalityReport/convertToCobraV2.html" class="code" title="function model=convertToCobraV2(model)">convertToCobraV2</a>	Generate a model structure with metabolite and reaction subfields instead of vectors.</li><li><a href="../setupThermoModel/directionalityReport/directionalityCheckAll.html" class="code" title="function directions=directionalityCheckAll(model,cumNormProbCutoff,thorStandard,printToFile,printToTable,figures)">directionalityCheckAll</a>	Analysis of differences between qualitative and quantiative directionality assignments.</li><li><a href="../setupThermoModel/directionalityReport/readableCobraModel.html" class="code" title="function model=readableCobraModel(model)">readableCobraModel</a>	Make a spreadsheet view of the model content for ease of viewing.</li><li><a href="../setupThermoModel/directionalityReport/standardGibbsFormationEnergyStats.html" class="code" title="function [nKeq,nGC,nNone]=standardGibbsFormationEnergyStats(modelT,figures)">standardGibbsFormationEnergyStats</a>	Generate the stats +/- pie chart on the provinence of the metabolite standard Gibbs energies.</li><li><a href="../setupThermoModel/experimentalData/readMetRxnBoundsFiles.html" class="code" title="function model=readMetRxnBoundsFiles(model,setDefaultConc,setDefaultFlux,defaultMetBounds,metBoundsFile,rxnBoundsFile)">readMetRxnBoundsFiles</a>	Set default concentration and flux bounds, and/or optionally read in upper and lower bounds from files.</li><li><a href="../setupThermoModel/firstPass/assignThermoToModel.html" class="code" title="function model=assignThermoToModel(model,Alberty2006,computedSpeciesData,temp,PHR,IS,CHI,compartments,NaNdGf0GCMetBool,Legendre,LegendreCHI,useKeqData,printToFile)">assignThermoToModel</a>	Assigns thermodynamic data to model at given temperature, pH, ionic strength and electrical potential.</li><li><a href="../setupThermoModel/firstPass/deltaG0concFluxConstraintBounds.html" class="code" title="function model=deltaG0concFluxConstraintBounds(model,Legendre,LegendreCHI,figures,nStdDevGroupCont)">deltaG0concFluxConstraintBounds</a>	set reaction directionality bounds from thermodynamic data</li><li><a href="../setupThermoModel/massBalance/checkBalance.html" class="code" title="function [dE,E]=checkBalance(model,element,printLevel)">checkBalance</a>	Checks whether a set of reactions is elementally balanced.</li><li><a href="../setupThermoModel/massBalance/findSExRxnInd.html" class="code" title="function model=findSExRxnInd(model,nRealMet)">findSExRxnInd</a>	Returns a model with boolean vectors indicating internal vs exchange/demand/sink reactions.</li><li><a href="../setupThermoModel/massBalance/getChargeFromInChI.html" class="code" title="function charge=getChargeFromInChI(InChI)">getChargeFromInChI</a>	return the charge from a given InChI string</li><li><a href="../setupThermoModel/massBalance/getFormulaFromInChI.html" class="code" title="function formula=getFormulaFromInChI(InChI)">getFormulaFromInChI</a>	extract formula from InChI</li><li><a href="../setupThermoModel/massBalance/pHbalanceProtons.html" class="code" title="function model=pHbalanceProtons(model,massImbalance)">pHbalanceProtons</a>	Mass balance protons for each reaction by adjusting the hydrogen ion stoichiometric coefficient.</li><li><a href="../setupThermoModel/secondPass/secondPassDirectionalityAssignment.html" class="code" title="function  [model,solutionThermoRecon,solutionRecon,model1]=secondPassDirectionalityAssignment(model)">secondPassDirectionalityAssignment</a>	Driver to call model specific code to manually generate a physiological model (if first pass does not result in a physiological model).</li><li><a href="../setupThermoModel/transport/getCompartment.html" class="code" title="function [compartments,uniqueCompartments]=getCompartment(mets,numChar)">getCompartment</a>	Get the compartment for each metabolite, and the unique compartments</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../setupThermoModel/directionalityReport/qualitativeVSquantitativeChangesTable.html" class="code" title="">qualitativeVSquantitativeChangesTable</a>	Example of a script that can be used to set up different thermodynamic models depending on the pH temp etc</li><li><a href="../setupThermoModel/old/scanThermoParam.html" class="code" title="function [scanParam,METDATA]=scanThermoParam(model,resolution,metAbbrAlbertyAbbr,iAF1260,Alberty2006,biomassRxnAbbr,Ecoli_symphID_rxnAbbr)">scanThermoParam</a>	parameter scan of the thermodynamic parameters for each metabolite</li><li><a href="../setupThermoModel/testing/testInterCompartmentRxn.html" class="code" title="function [dGt,dGt0,dGft,dGft0,SpH,aveHbound,aveZi,pHVec,isVec,chiVec]=testInterCompartmentRxn(model,rxnAbbr,PHmin,PHmax,ISmin,ISmax,CHImin,CHImax,N)">testInterCompartmentRxn</a>	Calculates the transformed Gibbs energy for a reaction and</li><li><a href="../setupThermoModel/testing/testSetupThermoModel.html" class="code" title="">testSetupThermoModel</a>	script for testing functionality of vonBertalanffy COBRA toolbox extension</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = checkMassChargeBalance(model,rxnBool,printLevel)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [modelT,directions,solutionThermoRecon]=setupThermoModel(model,metAbbrAlbertyAbbr,</a><span class="keyword">...</span>
0002     metGroupCont,Alberty2006,computedSpeciesData,temp,PHA,IS,CHI,biomassRxnAbbr,<span class="keyword">...</span>
0003     rxnAbbrDatabaseID,defaultMetBounds,metBoundsFile,rxnBoundsFile,Legendre,useKeqData,<span class="keyword">...</span>
0004     nStdDevGroupCont,cumNormProbCutoff,figures,printToFile,secondPassAssignment)
0005 <span class="comment">% Thermodynamically constrains a COBRA model.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% This function takes as imput an ordinary COBRA model (such as from sbml.xml)</span>
0008 <span class="comment">% then uses thermodynamic data to setup a thermodynamic COBRA model.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%INPUT</span>
0011 <span class="comment">% model</span>
0012 <span class="comment">% model.biomassRxnAbbr      abbreviation of biomass reaction</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% Alberty2006  Basic data on the metabolite species that make</span>
0015 <span class="comment">%              up a reactant, compiled by Robert A. Alberty,</span>
0016 <span class="comment">%              Massachusetts Institute of Technology.</span>
0017 <span class="comment">%              In Print: Robert A. Alberty, Biochemical Thermodynamics:</span>
0018 <span class="comment">%              Applications of Mathematica. John Wiley &amp; Sons, 2006. p391-395</span>
0019 <span class="comment">%              Online: BasicBioChemData3.nb</span>
0020 <span class="comment">%              http://library.wolfram.com/infocenter/MathSource/5704/</span>
0021 <span class="comment">%              Only species of interest in the range pH 5 to 9 are included.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Alberty2006 is a structure with two fields for each metabolite:</span>
0024 <span class="comment">% Alberty2006.abbreviation(i) Alberty reactant abbreviation</span>
0025 <span class="comment">% Alberty2006.basicData(i) cell array with 4 columns: dGf0,dHf0,charge,#Hydrogens</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% metAbbrAlbertyAbbr    mapping from model metabolite primary key to</span>
0028 <span class="comment">%                       primary key of reactants in Alberty2006</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% metGroupCont  Group contribution data, derived by submitting metabolite</span>
0031 <span class="comment">%               .mol files to the web based implementation, as described in:</span>
0032 <span class="comment">%               M. D. Jankowski, C. S. Henry, L. J. Broadbelt, and V. Hatzimanikatis.</span>
0033 <span class="comment">%               Group contribution method for thermodynamic analysis of complex metabolic networks.</span>
0034 <span class="comment">%               Biophys J, 95(3):1487-1499, Aug 2008.</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% computedSpeciesData   Structure with the same format as Alberty2006.</span>
0037 <span class="comment">%                       Basic data on metabolite species computed from group contribution data</span>
0038 <span class="comment">%                       and pKas estimated with ChemAxon's pKa calculator</span>
0039 <span class="comment">%                       plugin. Optional ([] if not available). Overwrites</span>
0040 <span class="comment">%                       data from metGroupCont if available. - Hulda</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% metGroupCont has the following fields</span>
0043 <span class="comment">% metGroupCont(m).abbreviation                      metabolite abbreviation</span>
0044 <span class="comment">% metGroupCont(m).delta_G_formation                 estimate of standard Gibbs energy of formation</span>
0045 <span class="comment">% metGroupCont(m).delta_G_formation_uncertainty     standard error in estimate of standard Gibbs energy of formation</span>
0046 <span class="comment">% metGroupCont(m).formulaMarvin                     metabolite formula of molfile (Marvin)</span>
0047 <span class="comment">% metGroupCont(m).chargeMarvin                      metabolite charge of molfile (Marvin)</span>
0048 <span class="comment">% metGroupCont(m).groupContribution_pH              glass electrode pH of metabolite molfile</span>
0049 <span class="comment">% metGroupCont(m).groupContribution_file            fileName with origin of group contribution data</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% temp              temperature 298.15 K to 313.15 K</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% PHA.*             glass electrode pH, between 5-9, in compartment defined by letter *</span>
0054 <span class="comment">%                   *   compartment</span>
0055 <span class="comment">%                   c   cytoplasm</span>
0056 <span class="comment">%                   p   periplasm</span>
0057 <span class="comment">%                   e   extracellular environment</span>
0058 <span class="comment">%                   m   mitochondria</span>
0059 <span class="comment">%                   n   nucleus</span>
0060 <span class="comment">%                   r   endoplasmic reticulum</span>
0061 <span class="comment">%                   g   Golgi apparatus</span>
0062 <span class="comment">%                   l   lysosome</span>
0063 <span class="comment">%                   x   peroxisome</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% IS.*              ionic strength (0 - 0.35M) in compartment defined by letter *</span>
0066 <span class="comment">%</span>
0067 <span class="comment">% CHI.*             electrical potential (mV) in compartment defined byletter *</span>
0068 <span class="comment">%</span>
0069 <span class="comment">% rxnAbbrDatabaseID   n x 2 cell array of reaction abbreviation and</span>
0070 <span class="comment">%                     corresponding database ID</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% defaultMetBounds.*  Default bounds on metabolite concentrations in mol/L. Used for</span>
0073 <span class="comment">%                     all metabolites except those listed in metBoundsFile.</span>
0074 <span class="comment">%                     - Hulda</span>
0075 <span class="comment">%                     *    ub or lb</span>
0076 <span class="comment">%                     ub   upper bound</span>
0077 <span class="comment">%                     lb   lower bound</span>
0078 <span class="comment">%</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% OPTIONAL INPUT</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% metBoundsFile     filename with upper &amp; lower bounds on metabolite</span>
0083 <span class="comment">%                   concentrations (Molar)</span>
0084 <span class="comment">%                   See 'model_met_bounds.txt' for format required</span>
0085 <span class="comment">% rxnBoundsFile     filename with upper &amp; lower bounds on fluxes</span>
0086 <span class="comment">%                   (mmol gDw-1 hr-1)</span>
0087 <span class="comment">%                   See 'model_rxn_bounds.txt' for format required</span>
0088 <span class="comment">%</span>
0089 <span class="comment">% Legendre              {(1),0} Legendre Transformation of dGf0?</span>
0090 <span class="comment">% useKeqData            {(1),0} Use dGf0 back calculated from Keq?</span>
0091 <span class="comment">% nStdDevGroupCont      {1} number of standard deviations of group contribution</span>
0092 <span class="comment">%                       uncertainty to be used for each metabolite</span>
0093 <span class="comment">% cumNormProbCutoff     {0.1} positive real number between 0 and 0.5 that</span>
0094 <span class="comment">%                       specifies to tolerance when there is uncertainty in group</span>
0095 <span class="comment">%                       contribution estimates.</span>
0096 <span class="comment">% figures               {0}, 1 = create figures</span>
0097 <span class="comment">% printToFile           {0}, 1 = print out to log files</span>
0098 <span class="comment">% secondPassAssignment  {0}, 1 = assign reaction directions based on the P(\Delta_{r}G^{\primeo}&lt;0)</span>
0099 <span class="comment">%                       that calculates the probability of a reaction being irreversible, given</span>
0100 <span class="comment">%                       the available thermodynamic data.</span>
0101 <span class="comment">%                       Doing so may prevent the model from growing, therefore at this stage it</span>
0102 <span class="comment">%                       is necessary to manually adjust some of the reaction directionalities</span>
0103 <span class="comment">%                       such that the model can grow, and grow at a similar rate as observed in</span>
0104 <span class="comment">%                       vivo. Therefore this script cannot be made model invariant as there is an</span>
0105 <span class="comment">%                       essential manual debugging stage.</span>
0106 <span class="comment">%                       A script is provided for E. coli iAF1260:</span>
0107 <span class="comment">%                       setThermoReactionDirectionalityiAF1260.m</span>
0108 <span class="comment">%</span>
0109 <span class="comment">%OUTPUT</span>
0110 <span class="comment">% modelT        a thermodynamic constraints based model</span>
0111 <span class="comment">%</span>
0112 <span class="comment">% modelT.gasConstant       Gas Constant</span>
0113 <span class="comment">% modelT.faradayConstant   Faraday Constant</span>
0114 <span class="comment">% modelT.temp              Temp</span>
0115 <span class="comment">%</span>
0116 <span class="comment">% modelT.met(m).dGft0                standard transformed Gibbs energy of formation(kJ/mol)</span>
0117 <span class="comment">% modelT.met(m).dGft0Source          origin of data, Keq or groupContFileName.txt</span>
0118 <span class="comment">% modelT.met(m).dGft0Keq             standard transformed Gibbs energy of formation(kJ/mol)</span>
0119 <span class="comment">% modelT.met(m).dGft0GroupCont            group. cont. estimate of standard transformed Gibbs energy of formation(kJ/mol)</span>
0120 <span class="comment">% modelT.met(m).dGf0GroupCont             group. cont. estimate of standard Gibbs energy of formation(kJ/mol)</span>
0121 <span class="comment">% modelT.met(m).dGf0GroupContUncertainty  group. cont. uncertainty in estimate of standard Gibbs energy of formation (kJ/mol)</span>
0122 <span class="comment">% modelT.met(m).mf           mole fraction of each species within a pseudoisomer group</span>
0123 <span class="comment">% modelT.met(m).aveZi        average charge</span>
0124 <span class="comment">% modelT.met(m).chi          electrical potential</span>
0125 <span class="comment">% modelT.met(m).aveHbound    average number of protons bound to a reactant</span>
0126 <span class="comment">%</span>
0127 <span class="comment">% modelT.lb_reconThermo      lower bound from amalgamation of reconstruction</span>
0128 <span class="comment">%                            and thermodynamic assignment directions</span>
0129 <span class="comment">% modelT.ub_reconThermo      upper bound from amalgamation of reconstruction</span>
0130 <span class="comment">%                            and thermodynamic assignment directions</span>
0131 <span class="comment">%</span>
0132 <span class="comment">% directions    a structue of boolean vectors with different directionality</span>
0133 <span class="comment">%               assignments where some vectors contain subsets of others</span>
0134 <span class="comment">%</span>
0135 <span class="comment">% qualitatively assigned directions</span>
0136 <span class="comment">%       directions.fwdReconBool</span>
0137 <span class="comment">%       directions.revReconBool</span>
0138 <span class="comment">%       directions.reversibleReconBool</span>
0139 <span class="comment">%</span>
0140 <span class="comment">% qualitatively assigned directions using thermo in preference to</span>
0141 <span class="comment">% qualitative assignments but using qualitative assignments where</span>
0142 <span class="comment">% thermodynamic data is lacking</span>
0143 <span class="comment">%       directions.fwdReconThermoBool</span>
0144 <span class="comment">%       directions.revReconThermoBool</span>
0145 <span class="comment">%       directions.reversibleReconThermoBool</span>
0146 <span class="comment">%</span>
0147 <span class="comment">% reactions that are qualitatively assigned by thermodynamics</span>
0148 <span class="comment">%       directions.fwdThermoOnlyBool</span>
0149 <span class="comment">%       directions.revThermoOnlyBool</span>
0150 <span class="comment">%       directions.reversibleThermoOnlyBool</span>
0151 <span class="comment">%</span>
0152 <span class="comment">% qualtiative -&gt; quantiative changed reaction directions</span>
0153 <span class="comment">%       directions.ChangeReversibleFwd</span>
0154 <span class="comment">%       directions.ChangeReversibleRev</span>
0155 <span class="comment">%       directions.ChangeForwardReverse</span>
0156 <span class="comment">%       directions.ChangeForwardReversible</span>
0157 <span class="comment">%</span>
0158 <span class="comment">% subsets of forward qualtiative -&gt; reversible quantiative change</span>
0159 <span class="comment">%   directions.ChangeForwardReversible_dGfKeq</span>
0160 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC</span>
0161 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_byConcLHS</span>
0162 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_byConcRHS</span>
0163 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_bydGt0</span>
0164 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_bydGt0LHS</span>
0165 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_bydGt0Mid</span>
0166 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_bydGt0RHS</span>
0167 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_byConc_No_dGt0ErrorLHS</span>
0168 <span class="comment">%   directions.ChangeForwardReversibleBool_dGfGC_byConc_No_dGt0ErrorRHS</span>
0169 <span class="comment">%</span>
0170 <span class="comment">%       directions.cumNormProbCutoff</span>
0171 <span class="comment">%       directions.ChangeForwardForwardBool_dGfGC</span>
0172 <span class="comment">%</span>
0173 <span class="comment">% solutionThermoRecon       FBA solution with thermodynamic in preference to</span>
0174 <span class="comment">%                           reconstruction directions</span>
0175 <span class="comment">%                           (see setThermoReactionDirectionality.m)</span>
0176 <span class="comment">%</span>
0177 <span class="comment">% DEPENDENCIES ON OTHER COBRA TOOLBOX FUNCTIONS</span>
0178 <span class="comment">% findRxnIDs.m</span>
0179 <span class="comment">% printRxnFormula.m</span>
0180 <span class="comment">%</span>
0181 <span class="comment">% OPTIONAL DEPENDENCIES ON OTHER PACKAGES (i.e. more accurate)</span>
0182 <span class="comment">% Multiple Precision Toolbox for MATLAB by Ben Barrowes (mptoolbox_1.1)</span>
0183 <span class="comment">% http://www.mathworks.com/matlabcentral/fileexchange/6446</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% COBRA TOOLBOX solvers e.g. solveCobraLP.m and solveCobraLPCPLEX.m for</span>
0186 <span class="comment">% conflict resolution for an infeasible LP.</span>
0187 <span class="comment">%</span>
0188 <span class="comment">% This code is part of the vonBertalanffy package for Systems Biothermodynamics.</span>
0189 <span class="comment">% Ludwig von Bertalanffy</span>
0190 <span class="comment">% http://en.wikipedia.org/wiki/Ludwig_von_Bertalanffy</span>
0191 <span class="comment">%</span>
0192 <span class="comment">% Ronan M.T. Fleming, Sept 2010.</span>
0193 <span class="comment">% Hulda SH, Dec 2010    Added computedSpeciesData as input. Passed into</span>
0194 <span class="comment">%                       assignThermoToModel for calculation of transformed Gibbs energies of</span>
0195 <span class="comment">%                       formation.</span>
0196 <span class="comment">% Hulda SH, Feb 2011    Made minor changes to some of the subfunctions.</span>
0197 
0198 <span class="keyword">if</span> ~exist(<span class="string">'Legendre'</span>,<span class="string">'var'</span>)
0199     Legendre=1;
0200 <span class="keyword">end</span>
0201 <span class="keyword">if</span> ~exist(<span class="string">'useKeqData'</span>,<span class="string">'var'</span>)
0202     useKeqData=1;
0203 <span class="keyword">end</span>
0204 <span class="keyword">if</span> ~exist(<span class="string">'nStdDevGroupCont'</span>,<span class="string">'var'</span>)
0205     nStdDevGroupCont=1;
0206 <span class="keyword">end</span>
0207 <span class="keyword">if</span> ~exist(<span class="string">'cumNormProbCutoff'</span>,<span class="string">'var'</span>)
0208     cumNormProbCutoff=0.1;
0209 <span class="keyword">end</span>
0210 <span class="keyword">if</span> ~exist(<span class="string">'figures'</span>,<span class="string">'var'</span>)
0211     figures=0;
0212 <span class="keyword">end</span>
0213 <span class="keyword">if</span> figures==1
0214     close all
0215 <span class="keyword">end</span>
0216 <span class="keyword">if</span> ~exist(<span class="string">'printToFile'</span>,<span class="string">'var'</span>)
0217     printToFile=0;
0218 <span class="keyword">end</span>
0219 <span class="keyword">if</span> ~exist(<span class="string">'heuristicAssignment'</span>,<span class="string">'var'</span>)
0220     heuristicAssignment=0;
0221 <span class="keyword">end</span>
0222 
0223 <span class="comment">%all possible compartments</span>
0224 numChar=1;
0225 [allMetCompartments,uniqueCompartments]=<a href="../setupThermoModel/transport/getCompartment.html" class="code" title="function [compartments,uniqueCompartments]=getCompartment(mets,numChar)">getCompartment</a>(model.mets,numChar);
0226 
0227 <span class="keyword">if</span> ~isfield(model,<span class="string">'biomassRxnAbbr'</span>)
0228     <span class="keyword">if</span> ~exist(<span class="string">'biomassRxnAbbr'</span>)
0229         fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...checkObjective'</span>);
0230         objectiveAbbr=checkObjective(model);
0231         fprintf(<span class="string">'%s\n'</span>,[<span class="string">'Asumming objective is '</span> objectiveAbbr]);
0232         model.biomassRxnAbbr=objectiveAbbr;
0233     <span class="keyword">else</span>
0234         model.biomassRxnAbbr=biomassRxnAbbr;
0235     <span class="keyword">end</span>
0236 <span class="keyword">end</span>
0237 
0238 model=<a href="../setupThermoModel/massBalance/findSExRxnInd.html" class="code" title="function model=findSExRxnInd(model,nRealMet)">findSExRxnInd</a>(model);
0239 fprintf(<span class="string">'\n'</span>);
0240 
0241 <span class="keyword">if</span> printToFile
0242     <span class="comment">%create a folder to contain the directionality report</span>
0243     <span class="keyword">if</span> ~isfield(model,<span class="string">'description'</span>)
0244         model.description=<span class="string">''</span>;
0245     <span class="keyword">end</span>
0246     folderName=[model.description <span class="string">'_thermoDirectionality_'</span> date];
0247     mkdir(folderName)
0248     fullFolderName=[pwd <span class="string">'/'</span> folderName];
0249     cd(fullFolderName);
0250 <span class="keyword">end</span>
0251 
0252 [nMet,nRxn]=size(model.S);
0253 <span class="keyword">for</span> m=1:nMet
0254     <span class="keyword">if</span> 0 &amp;&amp; strcmp(model.mets{m,1},<span class="string">'h[c]'</span>)
0255         pause(eps)
0256     <span class="keyword">end</span>
0257     <span class="keyword">if</span> strcmp(model.metFormulas{m,1},<span class="string">''</span>)
0258         fprintf(<span class="string">'%s\n'</span>,[model.mets{m} <span class="string">' getting formula and charge from InChI.'</span>])
0259         model.metCharges(m)=<a href="../setupThermoModel/massBalance/getChargeFromInChI.html" class="code" title="function charge=getChargeFromInChI(InChI)">getChargeFromInChI</a>(model.metInChIString{m});
0260         model.metFormulas{m}=<a href="../setupThermoModel/massBalance/getFormulaFromInChI.html" class="code" title="function formula=getFormulaFromInChI(InChI)">getFormulaFromInChI</a>(model.metInChIString{m});
0261     <span class="keyword">end</span>
0262 <span class="keyword">end</span>
0263 
0264 <span class="keyword">if</span> printToFile==1
0265     [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = <a href="#_sub1" class="code" title="subfunction [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = checkMassChargeBalance(model,rxnBool,printLevel)">checkMassChargeBalance</a>(model,[],-1);
0266 <span class="keyword">else</span>
0267     [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = <a href="#_sub1" class="code" title="subfunction [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = checkMassChargeBalance(model,rxnBool,printLevel)">checkMassChargeBalance</a>(model,[],1);
0268 <span class="keyword">end</span>
0269 <span class="comment">%save imbalances to model structure</span>
0270 model.imBalancedMass=imBalancedMass;
0271 model.imBalancedCharge=imBalancedCharge;
0272 
0273 <span class="keyword">if</span> isempty(imBalancedBool)
0274     imBalancedBool=false(nRxn,1);
0275 <span class="keyword">end</span>
0276 
0277 <span class="keyword">if</span> 0
0278     <span class="keyword">if</span> ~isempty(imBalancedMass)
0279         error(<span class="string">'Internal reactions are not mass balanced.'</span>)
0280     <span class="keyword">end</span>
0281     <span class="keyword">if</span> ~isempty(imBalancedCharge)
0282         error(<span class="string">'Internal reactions are not charge balanced.'</span>)
0283     <span class="keyword">end</span>
0284 <span class="keyword">else</span>
0285     <span class="keyword">if</span> ~isempty(imBalancedMass)
0286         warning(<span class="string">'Internal reactions are not mass balanced.'</span>)
0287     <span class="keyword">end</span>
0288     <span class="keyword">if</span> ~isempty(imBalancedCharge)
0289         warning(<span class="string">'Internal reactions are not charge balanced.'</span>)
0290     <span class="keyword">end</span>
0291 <span class="keyword">end</span>
0292 
0293 <span class="comment">%Physico-Chemical Constants (Energies are expressed in kJ/mol)</span>
0294 gasConstant = 8.314472/1000; <span class="comment">% kJ K-1 mol-1</span>
0295 faradayConstant = 96.48;     <span class="comment">% Coloumb mol-1</span>
0296 model.gasConstant=gasConstant;
0297 model.faradayConstant=faradayConstant;
0298 <span class="comment">%stamp model with intensive thermodynamic constants</span>
0299 model.PHA=PHA;
0300 model.IS=IS;
0301 model.temp=temp;
0302 
0303 <span class="comment">%optionally map reaction database ID's to model structure</span>
0304 <span class="keyword">if</span> exist(<span class="string">'rxnAbbrDatabaseID'</span>,<span class="string">'var'</span>)
0305     model=<a href="../setupThermoModel/database/mapDatabaseID.html" class="code" title="function model=mapDatabaseID(model,rxnAbbrDatabaseID)">mapDatabaseID</a>(model,rxnAbbrDatabaseID);
0306 <span class="keyword">end</span>
0307 
0308 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...convert COBRA model to metabolite and reaction centered format'</span>);
0309 <span class="comment">%DASHES NOT changed to UNDERSCORES in abbreviations</span>
0310 model=<a href="../setupThermoModel/directionalityReport/convertToCobraV2.html" class="code" title="function model=convertToCobraV2(model)">convertToCobraV2</a>(model);
0311 
0312 <span class="comment">%adjust for reactions involving co2 and succinate dehydrogenase reaction</span>
0313 model=<a href="../setupThermoModel/alberty/thermodynamicAdjustmentToStoichiometry.html" class="code" title="function model=thermodynamicAdjustmentToStoichiometry(model)">thermodynamicAdjustmentToStoichiometry</a>(model);
0314 [nMet,nRxn]=size(model.S);
0315 
0316 <span class="comment">%readjust the length of the boolean vector indicating unbalanced reactions</span>
0317 <span class="comment">% imBalancedBool2=false(nRxn,1);</span>
0318 <span class="comment">% imBalancedBool2(1:length(imBalancedBool),1)=imBalancedBool;</span>
0319 <span class="comment">% imBalancedBool=imBalancedBool2;</span>
0320 massImbalance=[massImbalance;sparse(nRxn-size(massImbalance,1),size(massImbalance,2))];
0321 
0322 <span class="keyword">if</span> 0 <span class="comment">%set this off by default from Jan 30th 2011</span>
0323     <span class="comment">% Sets any reactions that have equal upper bounds to be forward reaction</span>
0324     fprintf(<span class="string">'%s\n'</span>,<span class="string">'Checking for reactions that have equal upper and lower bounds...'</span>);
0325     <span class="keyword">for</span> n=1:nRxn
0326         <span class="keyword">if</span> model.lb(n)==0 &amp;&amp; model.ub(n)==0
0327             <span class="comment">%         error(['Reaction ' model.rxns{n} ' lb=ub=zero'])</span>
0328             warning([<span class="string">'Reaction '</span> model.rxns{n} <span class="string">' lb=ub=zero'</span>]);
0329             fprintf(<span class="string">'%s\n'</span>,[<span class="string">'Reaction '</span> model.rxns{n} <span class="string">' '</span> model.rxn(n).officialName <span class="string">' set to forward'</span>]);
0330             model.lb(n)=0;
0331             model.ub(n)=1000;
0332             model.rxn(n).directionality=<span class="string">'forward'</span>;
0333             model.rxn(n).regulationStatus=<span class="string">'Off'</span>;
0334         <span class="keyword">else</span>
0335             model.rxn(n).regulationStatus=<span class="string">'On'</span>;
0336         <span class="keyword">end</span>
0337     <span class="keyword">end</span>
0338 <span class="keyword">end</span>
0339     
0340 <span class="comment">%new reactions may have been added so update model size</span>
0341 [nMet,nRxn]=size(model.S);
0342 
0343 <span class="comment">%add constraint sense, including for new rows, if any.</span>
0344 <span class="keyword">if</span> ~isfield(model,<span class="string">'csense'</span>)
0345     model.csense(1:nMet)=<span class="string">'E'</span>;
0346 <span class="keyword">end</span>
0347 
0348 <span class="comment">% load Ecoli_metName_albertyAbbreviation;</span>
0349 nAlbertyMet=size(metAbbrAlbertyAbbr,1);
0350 <span class="comment">%replace any underscores in metabolite abbreviations with dashes</span>
0351 <span class="keyword">for</span> m=1:length(metGroupCont)
0352     x = strfind(metGroupCont(m).abbreviation,<span class="string">'_'</span>);
0353     <span class="keyword">if</span> x~=0
0354         metGroupCont(m).abbreviation(x)=<span class="string">'-'</span>;
0355     <span class="keyword">end</span>
0356 <span class="keyword">end</span>
0357 
0358 fprintf(<span class="string">'%s\n'</span>,<span class="string">'...replace any underscores in metabolite abbreviations with dashes'</span>);
0359 <span class="keyword">for</span> m=1:nAlbertyMet
0360     abbr=metAbbrAlbertyAbbr{m,2};
0361     x = strfind(abbr,<span class="string">'_'</span>);
0362     <span class="keyword">if</span> x~=0
0363         abbr(x)=<span class="string">'-'</span>;
0364         metAbbrAlbertyAbbr{m,2}=abbr;
0365     <span class="keyword">end</span>
0366 <span class="keyword">end</span>
0367 
0368 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...mapping Alberty abbreviations to model using metAbbrAlbertyAbbr.'</span>);
0369 <span class="keyword">if</span> printToFile
0370     fid=fopen(<span class="string">'metabolites_with_no_Alberty_abbreviation.txt'</span>,<span class="string">'w'</span>);
0371 <span class="keyword">end</span>
0372 <span class="keyword">for</span> m=1:nMet
0373     got=0;
0374     <span class="keyword">for</span> a=1:nAlbertyMet
0375         metAbbr=model.mets{m};
0376         <span class="comment">%dont include compartment</span>
0377         metAbbr=metAbbr(1:end-3);
0378         <span class="keyword">if</span> strcmp(metAbbr,metAbbrAlbertyAbbr{a,2})
0379             <span class="keyword">if</span> ~isempty(metAbbrAlbertyAbbr{a,3})
0380                 model.met(m).albertyAbbreviation=metAbbrAlbertyAbbr{a,3};
0381                 got=1;
0382             <span class="keyword">end</span>
0383             <span class="keyword">break</span>;
0384         <span class="keyword">end</span>
0385     <span class="keyword">end</span>
0386     <span class="keyword">if</span> got==0
0387         metAbbr=model.mets{m};
0388         <span class="keyword">if</span> strcmp(metAbbr(end-2:end),<span class="string">'[c]'</span>)
0389             <span class="keyword">if</span> printToFile==0
0390                 fprintf(<span class="string">'%s\t%s\t%20s\t%s\n'</span>,<span class="string">'No Alberty abbreviation for metabolite'</span>, int2str(m),model.mets{m},model.met(m).officialName);
0391             <span class="keyword">else</span>
0392                 fprintf(fid,<span class="string">'%s\t%s\t%s\t%s\n'</span>,<span class="string">'No Alberty abbreviation for metabolite'</span>, int2str(m),model.mets{m},model.met(m).officialName);
0393             <span class="keyword">end</span>
0394         <span class="keyword">end</span>
0395     <span class="keyword">end</span>
0396 <span class="keyword">end</span>
0397 <span class="keyword">if</span> printToFile
0398     fclose(fid);
0399 <span class="keyword">end</span>
0400 
0401 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...assignment of Group Contribution data to model using metGroupCont structure.'</span>);
0402 <span class="comment">%assign Group Contribution data to model using metGroupCont</span>
0403  fprintf(<span class="string">'%s\n'</span>,<span class="string">'Energies are expressed in kJ mol^-1'</span>)
0404 nMetGroupCont=length(metGroupCont);
0405 NaNdGf0GCMetBool=false(nMet,1);
0406 metGroupContAbbr=cell(nMetGroupCont,1);
0407 <span class="keyword">for</span> a=1:nMetGroupCont
0408     metGroupContAbbr{a,1}=metGroupCont(a).abbreviation;
0409 <span class="keyword">end</span>
0410 <span class="comment">%check if compartment identifier is also in metabolite abbreviation</span>
0411 <span class="keyword">if</span> strcmp(metGroupCont(1).abbreviation(end),<span class="string">']'</span>)
0412     <span class="comment">%check if metabolite abbreviation in model matches any in group</span>
0413     <span class="comment">%contribution data</span>
0414     <span class="keyword">for</span> m=1:nMet
0415         bool=strcmp(model.mets{m},metGroupContAbbr);
0416         <span class="keyword">if</span> ~any(bool)
0417             <span class="comment">%mark as missing</span>
0418             NaNdGf0GCMetBool(m,1)=1;
0419             model.met(m).dGf0GroupCont=NaN;
0420             model.met(m).dGf0GroupContUncertainty=NaN;
0421             model.met(m).formulaMarvin=NaN;
0422             model.met(m).chargeMarvin=NaN;
0423             model.met(m).groupContribution_pH=NaN;
0424             model.met(m).groupContribution_file=NaN;
0425         <span class="keyword">else</span>
0426             <span class="keyword">if</span> nnz(bool)&gt;1
0427                 error([metAbbr <span class="string">': duplicated abbreviation[*] in group contribution data'</span>]);
0428             <span class="keyword">else</span>
0429                 <span class="comment">%chemical standard chemical potential is  independent of compartment</span>
0430                 <span class="comment">%TODO - group contribution estimate specific to pH</span>
0431                 <span class="comment">%Energies are expressed in kJ mol^-1 so convert from  kCal</span>
0432                 model.met(m).dGf0GroupCont=metGroupCont(bool).delta_G_formation*(8.314472/1.987);
0433                 model.met(m).dGf0GroupContUncertainty=metGroupCont(bool).delta_G_formation_uncertainty*(8.314472/1.987);
0434                 model.met(m).formulaMarvin=metGroupCont(bool).formulaMarvin;
0435                 model.met(m).chargeMarvin=metGroupCont(bool).chargeMarvin;
0436                 model.met(m).groupContribution_pH=metGroupCont(bool).pH;
0437                 model.met(m).groupContribution_file=metGroupCont(bool).file;
0438             <span class="keyword">end</span>
0439         <span class="keyword">end</span>
0440     <span class="keyword">end</span>
0441 <span class="keyword">else</span>
0442     <span class="keyword">for</span> m=1:nMet
0443         <span class="keyword">if</span> strcmp(model.met(m).abbreviation,<span class="string">'damval[c]'</span>);
0444             pause(eps)
0445         <span class="keyword">end</span>
0446         
0447         <span class="comment">%check if metabolite abbreviation in model matches any in group</span>
0448         <span class="comment">%contribution data</span>
0449         metAbbr=model.met(m).abbreviation;
0450         metAbbr=metAbbr(1:end-3);
0451         bool=strcmp(metAbbr,metGroupContAbbr);
0452         <span class="keyword">if</span> ~any(bool)
0453             <span class="comment">%mark as missing</span>
0454             NaNdGf0GCMetBool(m,1)=1;
0455             
0456             model.met(m).dGf0GroupCont=NaN;
0457             model.met(m).dGf0GroupContUncertainty=NaN;
0458             model.met(m).formulaMarvin=NaN;
0459             model.met(m).chargeMarvin=NaN;
0460             model.met(m).groupContribution_pH=NaN;
0461             model.met(m).groupContribution_file=NaN;
0462         <span class="keyword">else</span>
0463             bool=find(bool);
0464             bool=bool(1);
0465             <span class="keyword">if</span> nnz(bool)&gt;1
0466                 error([metAbbr <span class="string">': duplicated abbreviation in group contribution data'</span>]);
0467             <span class="keyword">else</span>
0468                 <span class="comment">%chemical standard chemical potential is  independent of compartment</span>
0469                 <span class="comment">%TODO - Assign pH to input for OpenBabel to get InChi strings specific</span>
0470                 <span class="comment">%to pH</span>
0471                 <span class="comment">%Energies are expressed in kJ mol^-1 so convert from  kCal</span>
0472                 model.met(m).dGf0GroupCont=metGroupCont(bool).delta_G_formation*(8.314472/1.987);
0473                 model.met(m).dGf0GroupContUncertainty=metGroupCont(bool).delta_G_formation_uncertainty*(8.314472/1.987);
0474                 model.met(m).formulaMarvin=metGroupCont(bool).formulaMarvin;
0475                 model.met(m).chargeMarvin=metGroupCont(bool).chargeMarvin;
0476                 model.met(m).groupContribution_pH=metGroupCont(bool).pH;
0477                 model.met(m).groupContribution_file=metGroupCont(bool).file;
0478             <span class="keyword">end</span>
0479         <span class="keyword">end</span>
0480     <span class="keyword">end</span>
0481 <span class="keyword">end</span>
0482 
0483 
0484 <span class="comment">% Apparent glass electrode pH is not the same as real pH for thermodynamic calculations.</span>
0485 <span class="comment">% Given the experimental glass electrode measurement of pH, this function returns</span>
0486 <span class="comment">% the real pH to be used for thermodynamic calculations, pHr = -log10[H+],</span>
0487 <span class="comment">% by subtracting the effect of the ion atmosphere around H+ which</span>
0488 <span class="comment">% reduces its activity coefficient below unity.</span>
0489 <span class="comment">% See p49 Alberty 2003</span>
0490 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...realpH'</span>);
0491 <span class="keyword">for</span> p=1:length(uniqueCompartments)
0492     <span class="keyword">if</span> isfield(PHA,uniqueCompartments{p,1})
0493         <span class="comment">%if comparing this program against Albertys tables then use an apparent pH, i.e. pHa,</span>
0494         <span class="comment">%with a thermodynamic pH, i.e. pHr, that is equivalent</span>
0495         compareAgainstAlbertysTables=1; <span class="comment">%changed</span>
0496         <span class="keyword">if</span> compareAgainstAlbertysTables
0497             [pHr,pHAdjustment]=<a href="../setupThermoModel/alberty/realpH.html" class="code" title="function [pHr,pHAdjustment]=realpH(pHa,temp,is)">realpH</a>(PHA.(uniqueCompartments{p,1}),temp,IS.(uniqueCompartments{p,1}));
0498             PHA.(uniqueCompartments{p,1})=PHA.(uniqueCompartments{p,1})+pHAdjustment;
0499         <span class="keyword">else</span>
0500             fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'If comparing this data with Albertys tables, note that they use real pH.'</span>);
0501         <span class="keyword">end</span>
0502         
0503         [pHr,pHAdjustment]=<a href="../setupThermoModel/alberty/realpH.html" class="code" title="function [pHr,pHAdjustment]=realpH(pHa,temp,is)">realpH</a>(PHA.(uniqueCompartments{p,1}),temp,IS.(uniqueCompartments{p,1}));
0504         <span class="comment">%real thermodynamic pH</span>
0505         PHR.(uniqueCompartments{p,1})=pHr;
0506     <span class="keyword">end</span>
0507 <span class="keyword">end</span>
0508 
0509 <span class="comment">%Incorportate the electrochemical potential across the membrane by adding a</span>
0510 <span class="comment">%component to the standard chemical potential of external protons:</span>
0511 <span class="comment">%&quot;Escherichia coli Glutamate- and Arginine-Dependent Acid Resistance Systems Increase Internal pH and</span>
0512 <span class="comment">%Reverse Transmembrane Potential&quot; by Hope Richard and John W. Foster*</span>
0513 <span class="comment">%Data from Table 1</span>
0514 <span class="comment">%Given a medium at pH 7 the exterior of the cell has an electrical</span>
0515 <span class="comment">%potential 90mV lower than the exterior. Interior pH of 7.8. Culture temp</span>
0516 <span class="comment">%of 310.15K.</span>
0517 
0518 <span class="comment">%By default, make a Legendre transformation for electrical potential</span>
0519 LegendreCHI=1;
0520 
0521 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...assignThermoToModel'</span>);
0522 <span class="comment">%assign Alberty data to model, or Legendre transformed Henry data if no data</span>
0523 <span class="comment">%on metabolite is available from Alberty</span>
0524 <span class="comment">%this function is where most of the detailed physical chemistry implemented</span>
0525 <span class="comment">%by Alberty in mathematica, is implemented in matlab.</span>
0526 model=<a href="../setupThermoModel/firstPass/assignThermoToModel.html" class="code" title="function model=assignThermoToModel(model,Alberty2006,computedSpeciesData,temp,PHR,IS,CHI,compartments,NaNdGf0GCMetBool,Legendre,LegendreCHI,useKeqData,printToFile)">assignThermoToModel</a>(model,Alberty2006,computedSpeciesData,temp,PHR,IS,CHI,uniqueCompartments,NaNdGf0GCMetBool,Legendre,LegendreCHI,useKeqData,printToFile); <span class="comment">% Added computedSpeciesData as input. - Hulda</span>
0527 
0528 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...setCommonZeroStandardGibbsEnergyOfFormation'</span>);
0529 <span class="comment">% Set all the exceptional metabolites to have a common baseline.</span>
0530 <span class="comment">% i.e. Standard transformed Gibbs energies of reactants with the baseline adjusted</span>
0531 <span class="comment">% for certain paired cofactors e.g. fad &amp; fadh2, such that the</span>
0532 <span class="comment">% difference between the two is the same as in Albertys data but</span>
0533 <span class="comment">% the absolute values are consistent with the group contribution data</span>
0534 <span class="keyword">if</span> 0
0535     model=<a href="../setupThermoModel/alberty/setCommonZeroStandardGibbsEnergyOfFormation.html" class="code" title="function model=setCommonZeroStandardGibbsEnergyOfFormation(model)">setCommonZeroStandardGibbsEnergyOfFormation</a>(model); 
0536 <span class="keyword">else</span>
0537     <span class="comment">% Already adjusted manually - Hulda</span>
0538     fprintf(<span class="string">'Assuming that cofactors have same baseline as group contribution data'</span>);
0539 <span class="keyword">end</span>
0540 
0541 <span class="comment">%balance the protons in each reaction given the number of Hydrogens bound</span>
0542 <span class="comment">%to each reactant calculated thermodynamically using assignThermoToModel.m</span>
0543 
0544 <span class="comment">% if 1 %TODO Jan 30th 2011 Balancing protons changes growth rate ~0.7 -&gt; 1.1  Need to check</span>
0545 <span class="comment">%     fprintf('\n%s\n','...pHbalanceProtons');</span>
0546     model=<a href="../setupThermoModel/massBalance/pHbalanceProtons.html" class="code" title="function model=pHbalanceProtons(model,massImbalance)">pHbalanceProtons</a>(model,massImbalance); <span class="comment">% Minor changes - Hulda</span>
0547 <span class="comment">% end</span>
0548 
0549 <span class="comment">%plot statistics on the number of reactants with significant</span>
0550 <span class="comment">%non-predominant mole fractions &gt;0.05</span>
0551 <span class="keyword">if</span> figures
0552     <a href="../setupThermoModel/alberty/moleFractionStats.html" class="code" title="function moleFractionStats(modelT)">moleFractionStats</a>(model) <span class="comment">% Minor changes - Hulda</span>
0553 <span class="keyword">end</span>
0554 
0555 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'... readMetRxnBoundsFiles'</span>);
0556 <span class="comment">%assign bounds on metabolite concentrations and fluxes</span>
0557 
0558 <span class="comment">% setDefaultConc            sets default bounds on conc [1e-5,0.02]</span>
0559 setDefaultConc=1;
0560 <span class="comment">% setDefaultFlux            sets all reactions reversible [-1000,1000]</span>
0561 setDefaultFlux=0;<span class="comment">% set to zero since we use the bounds given by</span>
0562 
0563 <span class="comment">%locations of the files with the bounds on metabolite concentration</span>
0564 <span class="comment">%and reaction flux</span>
0565 <span class="keyword">if</span> ~exist(<span class="string">'metBoundsFile'</span>,<span class="string">'var'</span>)
0566 <span class="comment">%     metBoundsFile='model_met_bounds.txt';</span>
0567 <span class="comment">%    metBoundsFile='Schuetz_met_data.txt';</span>
0568     metBoundsFile=<span class="string">'Bennet_Glucose_Aerobic.txt'</span>;
0569 <span class="comment">%     metBoundsFile='Bennet_Glucose_Aerobic_Cofactor.txt';</span>
0570 <span class="comment">%    metBoundsFile='Bennet_Glucose_Aerobic_Cofactor_ATPs.txt';</span>
0571 <span class="comment">%      metBoundsFile='Bennet_Glucose_Aerobic_Cofactor_NAD.txt';</span>
0572 <span class="keyword">end</span>
0573 <span class="keyword">if</span> ~exist(<span class="string">'rxnBoundsFile'</span>,<span class="string">'var'</span>)
0574 <span class="comment">%     rxnBoundsFile='model_rxn_bounds.txt';</span>
0575     rxnBoundsFile=<span class="string">'Ecoli_glucose_aerobic_rxn_bounds.txt'</span>;
0576 <span class="keyword">end</span>
0577 <span class="comment">% metBoundsFile=[];</span>
0578 <span class="comment">% rxnBoundsFile=[];</span>
0579 <span class="comment">%assign bounds to model +/- read in data from flat file</span>
0580 model=<a href="../setupThermoModel/experimentalData/readMetRxnBoundsFiles.html" class="code" title="function model=readMetRxnBoundsFiles(model,setDefaultConc,setDefaultFlux,defaultMetBounds,metBoundsFile,rxnBoundsFile)">readMetRxnBoundsFiles</a>(model,setDefaultConc,setDefaultFlux,defaultMetBounds,metBoundsFile,rxnBoundsFile); <span class="comment">% Passed in defaultMetBounds - Hulda</span>
0581 
0582 <span class="comment">%Special concentration bounds for o2, co2, h2o and h</span>
0583 <span class="keyword">for</span> m=1:nMet
0584     abbr=model.mets{m};
0585     abbrShort=abbr(1:end-3);
0586     compartment=abbr(end-1);
0587     
0588     <span class="comment">%water concentration assumed to be one molar p107 Alberty 2003</span>
0589     <span class="keyword">if</span> strcmp(<span class="string">'h2o'</span>,abbrShort)
0590         model.met(m).concMin=0.99;<span class="comment">%55.5062-1;;</span>
0591         model.met(m).concMax=1;<span class="comment">%55.5062+1;;</span>
0592     <span class="keyword">end</span>
0593 
0594     <span class="keyword">if</span> strcmp(<span class="string">'co2'</span>,abbrShort)
0595         <span class="keyword">if</span> strcmp(<span class="string">'co2[c]'</span>,abbr)
0596             model.met(m).concMin=10e-8;
0597             model.met(m).concMax=0.0014;
0598         <span class="keyword">else</span>
0599             model.met(m).concMin=0.0001;
0600             model.met(m).concMax=0.0001;
0601         <span class="keyword">end</span>
0602     <span class="keyword">end</span>
0603     
0604     <span class="comment">%From Henry et al</span>
0605     <span class="comment">% oxygen concentration selected for the media is 8.2E-6 M</span>
0606     <span class="comment">% and the oxygen concentration in the cell cannot exceed the concentration</span>
0607     <span class="comment">% in the media, the bounds on the oxygen concentration in the cell</span>
0608     <span class="comment">% were set from 10E-7 M to 8.2E-6M</span>
0609     <span class="keyword">if</span> strcmp(<span class="string">'o2'</span>,abbrShort)
0610         <span class="keyword">if</span> strcmp(<span class="string">'o2[c]'</span>,abbr)
0611             model.met(m).concMin=10e-8;
0612             model.met(m).concMax=8.2e-6;
0613         <span class="keyword">else</span>
0614             model.met(m).concMin=8.2e-8;
0615             model.met(m).concMax=8.2e-6;
0616         <span class="keyword">end</span>
0617     <span class="keyword">end</span>
0618     <span class="comment">%hydrogen ion concentration uses real pH (not apparent pH)</span>
0619     <span class="keyword">if</span> strcmp(<span class="string">'h'</span>,abbrShort)
0620         model.met(m).concMin=10^-PHR.(compartment);
0621         model.met(m).concMax=10^-PHR.(compartment);
0622     <span class="keyword">end</span>
0623 <span class="keyword">end</span>
0624 
0625 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'... deltaG0concFluxConstraintBounds'</span>);
0626 <span class="comment">%Set reaction directionality bounds from thermodynamic data:</span>
0627 <span class="comment">%set up bounds  on metabolite chemical potential</span>
0628 <span class="comment">%use to set upper &amp; lower thermodynamic bounds on internal fluxes</span>
0629 <span class="comment">%******************first pass***************</span>
0630 model=<a href="../setupThermoModel/firstPass/deltaG0concFluxConstraintBounds.html" class="code" title="function model=deltaG0concFluxConstraintBounds(model,Legendre,LegendreCHI,figures,nStdDevGroupCont)">deltaG0concFluxConstraintBounds</a>(model,Legendre,LegendreCHI,figures,nStdDevGroupCont); <span class="comment">% Minor changes - Hulda</span>
0631 
0632 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...standardGibbsFormationEnergyStats'</span>);
0633 <span class="comment">% figures=0;</span>
0634 [nKeq,nGC,nNone]=<a href="../setupThermoModel/directionalityReport/standardGibbsFormationEnergyStats.html" class="code" title="function [nKeq,nGC,nNone]=standardGibbsFormationEnergyStats(modelT,figures)">standardGibbsFormationEnergyStats</a>(model,figures);
0635 <span class="comment">% figures=1;</span>
0636 
0637 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...directionalityCheckAll'</span>);
0638 <span class="comment">%check the thermodynamically feasible directions with respect to the</span>
0639 <span class="comment">%reconstruction directions</span>
0640 <span class="keyword">if</span> printToFile
0641     <span class="comment">%print out problematic reactions in summary table format for paper</span>
0642     printToTable=1;
0643     <span class="comment">% cumNormProbCutoff     {0.1} positive real number between 0 and 0.5 that</span>
0644     <span class="comment">%                       specifies to tolerance when there is uncertainty in group</span>
0645     <span class="comment">%                       contribution estimates.</span>
0646 <span class="keyword">else</span>
0647     printToTable=0;
0648 <span class="keyword">end</span>
0649 
0650 <span class="comment">%create new standard Gibbs Free Energy based on the geometric mean of each</span>
0651 <span class="comment">%metabolites concentration range</span>
0652 thorStandard=0; <span class="comment">%zero for first pass is adivisable since growth may be infeasible</span>
0653 directions=<a href="../setupThermoModel/directionalityReport/directionalityCheckAll.html" class="code" title="function directions=directionalityCheckAll(model,cumNormProbCutoff,thorStandard,printToFile,printToTable,figures)">directionalityCheckAll</a>(model,cumNormProbCutoff,thorStandard,printToFile,printToTable,figures);
0654 <span class="comment">%boolean vectors indexing the reaction directionalities according to</span>
0655 <span class="comment">%different criteia</span>
0656 model.directions=directions;
0657 
0658 <span class="comment">%test the functionality of the model if cobra toolbox installed</span>
0659 <span class="keyword">if</span> exist(<span class="string">'solveCobraLP'</span>,<span class="string">'file'</span>)==0
0660     fprintf(<span class="string">'\n'</span>)
0661     fprintf(<span class="string">'%s\n'</span>,<span class="string">'No LP solver configured with a COBRA toolbox installation.'</span>);
0662     fprintf(<span class="string">'%s\n'</span>,<span class="string">'See http://gcrg.ucsd.edu/Downloads/Cobra_Toolbox'</span>);
0663     fprintf(<span class="string">'%s\n'</span>,<span class="string">'Checking the assignment of reaction directionality with FBA requires an LP solver.'</span>);
0664     solutionRecon=[];
0665     solutionThermoRecon=[];
0666     model1=[];
0667 <span class="keyword">else</span>
0668     <span class="comment">%******************first pass starts here ***************</span>
0669     <span class="comment">%minimiseNorm of all reactions</span>
0670     changeOK = changeCobraSolverParams(<span class="string">'LP'</span>,<span class="string">'minNorm'</span>,1e-6);
0671     
0672     <span class="comment">%FBA with reconstruction directions</span>
0673     solutionRecon = optimizeCbModel(model);
0674     
0675     <span class="comment">%FBA with qualitatively assigned directions using thermo in preference to</span>
0676     <span class="comment">% qualitative assignments but using qualitative assignments where</span>
0677     <span class="comment">% thermodynamic data is lacking</span>
0678     <span class="comment">% model.lb_reconThermo              lower bounds from dGtMin/dGtMax and recon</span>
0679     <span class="comment">%                                   directions if thermo data missing</span>
0680     <span class="comment">% model.ub_reconThermo              upper bounds from dGtMin/dGtMax and recon</span>
0681     <span class="comment">%                                   directions if thermo data missing</span>
0682     modelD=model;
0683     bool=~modelD.transportRxnBool &amp; ~modelD.NaNdG0RxnBool &amp; (modelD.directions.ChangeReversibleFwd | modelD.directions.ChangeReversibleRev | modelD.directions.ChangeForwardReverse);
0684     <span class="keyword">if</span> ~any(bool)
0685        warning(<span class="string">'No change in reactions'</span>)
0686     <span class="keyword">end</span>
0687     <span class="comment">%Amalgamation of recon &amp; thermo directions</span>
0688     modelD.lb(bool)=model.lb_reconThermo(bool);
0689     modelD.ub(bool)=model.ub_reconThermo(bool);
0690     <span class="comment">%FBA</span>
0691     solutionThermoRecon = optimizeCbModel(modelD);
0692     clear modelD
0693     fprintf(<span class="string">'\n%s\t%g\n'</span>,<span class="string">'Growth with reconstruction directions: '</span>,solutionRecon.f);
0694     fprintf(<span class="string">'\n%s\t%g\n'</span>,<span class="string">'Growth with amalgamation of recon &amp; thermo directions: '</span>,solutionThermoRecon.f);
0695     
0696     
0697     <span class="comment">%******************second pass starts here ***************</span>
0698     <span class="keyword">if</span> secondPassAssignment
0699         <span class="comment">%requires manual curation</span>
0700         [model,solutionThermoRecon,solutionRecon,model1]=<a href="../setupThermoModel/secondPass/secondPassDirectionalityAssignment.html" class="code" title="function  [model,solutionThermoRecon,solutionRecon,model1]=secondPassDirectionalityAssignment(model)">secondPassDirectionalityAssignment</a>(model);
0701     <span class="keyword">end</span>
0702 <span class="keyword">end</span>
0703 
0704 fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'...readableCobraModel'</span>);
0705 <span class="comment">%make the model readable</span>
0706 model=<a href="../setupThermoModel/directionalityReport/readableCobraModel.html" class="code" title="function model=readableCobraModel(model)">readableCobraModel</a>(model);
0707 
0708 <span class="keyword">if</span> Legendre==1 &amp;&amp; LegendreCHI
0709     fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'N.B. Thermodynamic properties calculated using a Legendre transform for pH and electrical potential.'</span>);
0710 <span class="keyword">else</span>
0711     fprintf(<span class="string">'\n%s\n'</span>,<span class="string">'N.B. Thermodynamic properties have not been calculated using a Legendre transform.'</span>);
0712 <span class="keyword">end</span>
0713 
0714 <span class="comment">%move out of folder</span>
0715 cd ..
0716 <span class="keyword">if</span> printToFile
0717     fprintf(<span class="string">'\n%s\n'</span>,[<span class="string">'Directionality report in folder: '</span> folderName]);
0718 <span class="keyword">end</span>
0719 <span class="comment">%change name of model</span>
0720 modelT=model;
0721 <span class="keyword">end</span>
0722 
0723 <span class="comment">%%%%%%%%% helper function which shadows a function in the COBRA toolbox</span>
0724 <a name="_sub1" href="#_subfunctions" class="code">function [massImbalance,imBalancedMass,imBalancedCharge,imBalancedBool,Elements] = checkMassChargeBalance(model,rxnBool,printLevel)</a>
0725 <span class="comment">%checkMassChargeBalance tests for a list of reactions if these reactions are</span>
0726 <span class="comment">%mass-balanced by adding all elements on left hand side and comparing them</span>
0727 <span class="comment">%with the sums of elements on the right hand side of the reaction.</span>
0728 <span class="comment">%</span>
0729 <span class="comment">% [UnbalancedRxns] = checkMassChargeBalance(model,RxnList)</span>
0730 <span class="comment">%</span>
0731 <span class="comment">%INPUT</span>
0732 <span class="comment">% model                         COBRA model structure</span>
0733 <span class="comment">%</span>
0734 <span class="comment">%OPTIONAL INPUT</span>
0735 <span class="comment">% rxnBool       Boolean vector corresponding to reactions in model to be</span>
0736 <span class="comment">%               tested. If empty, then all tested.</span>
0737 <span class="comment">%               Alternatively, can be the indices of reactions to test:</span>
0738 <span class="comment">%               i.e. rxnBool(indixes)=1;</span>
0739 <span class="comment">% printLevel    {-1,(0),1}</span>
0740 <span class="comment">%               -1 = print out diagnostics on problem reactions to a file</span>
0741 <span class="comment">%                0 = silent</span>
0742 <span class="comment">%                1 = print out diagnostics on problem reactions to screen</span>
0743 <span class="comment">%</span>
0744 <span class="comment">%OUTPUTS</span>
0745 <span class="comment">% massImbalance                 nRxn x nElement matrix with mass imblance</span>
0746 <span class="comment">%                               for each element checked. 0 if balanced.</span>
0747 <span class="comment">% imBalancedMass                nRxn x 1 cell with charge imbalance</span>
0748 <span class="comment">%                               e.g. -3 H means three hydrogens disappear</span>
0749 <span class="comment">%                               in the reaction.</span>
0750 <span class="comment">% imBalancedCharge              nRxn x 1 vector with charge imbalance,</span>
0751 <span class="comment">%                               empty if no imbalanced reactions</span>
0752 <span class="comment">%</span>
0753 <span class="comment">% imbalancedBool                boolean vector indicating imbalanced reactions</span>
0754 <span class="comment">%</span>
0755 <span class="comment">% Elements                      nElement x 1 cell array of element</span>
0756 <span class="comment">%                               abbreviations checked</span>
0757 <span class="comment">% Ines Thiele 12/09</span>
0758 <span class="comment">% IT, 06/10, Corrected some bugs and improved speed.</span>
0759 <span class="comment">% RF, 09/09/10, Support for very large models and printing to file.</span>
0760 
0761 [nMet,nRxn]=size(model.S);
0762 <span class="keyword">if</span> exist(<span class="string">'rxnBool'</span>,<span class="string">'var'</span>)
0763     <span class="keyword">if</span> ~isempty(rxnBool)
0764         <span class="keyword">if</span> length(rxnBool)~=nRxn
0765             rxnBool2=false(nRxn,1);
0766             rxnBool2(rxnBool)=1;
0767             rxnBool=rxnBool2;
0768         <span class="keyword">end</span>
0769         model=<a href="../setupThermoModel/massBalance/findSExRxnInd.html" class="code" title="function model=findSExRxnInd(model,nRealMet)">findSExRxnInd</a>(model);
0770         <span class="comment">%only check mass balance of internal reactions</span>
0771         rxnBool=rxnBool &amp; model.SIntRxnBool;
0772     <span class="keyword">else</span>
0773         model=<a href="../setupThermoModel/massBalance/findSExRxnInd.html" class="code" title="function model=findSExRxnInd(model,nRealMet)">findSExRxnInd</a>(model);
0774         <span class="comment">%only check mass balance of internal reactions</span>
0775         rxnBool=model.SIntRxnBool;
0776     <span class="keyword">end</span>
0777 <span class="keyword">else</span>
0778     model=<a href="../setupThermoModel/massBalance/findSExRxnInd.html" class="code" title="function model=findSExRxnInd(model,nRealMet)">findSExRxnInd</a>(model);
0779     <span class="comment">%only check mass balance of internal reactions</span>
0780     rxnBool=model.SIntRxnBool;
0781 <span class="keyword">end</span>
0782 <span class="keyword">if</span> ~exist(<span class="string">'printLevel'</span>,<span class="string">'var'</span>)
0783     printLevel=0;
0784 <span class="keyword">end</span>
0785 
0786 <span class="comment">% List of Elements</span>
0787 Elements = {<span class="string">'H'</span>,<span class="string">'C'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'S'</span>, <span class="string">'N'</span>, <span class="string">'Mg'</span>,<span class="string">'X'</span>,<span class="string">'Fe'</span>,<span class="string">'Zn'</span>,<span class="string">'Co'</span>,<span class="string">'R'</span>};
0788 
0789 E=sparse(nMet,length(Elements));
0790 massImbalance=sparse(nRxn,length(Elements));
0791 <span class="keyword">for</span> j = 1 : length(Elements)
0792     <span class="keyword">if</span> j==1
0793         [dE,E_el]=<a href="../setupThermoModel/massBalance/checkBalance.html" class="code" title="function [dE,E]=checkBalance(model,element,printLevel)">checkBalance</a>(model,Elements{j},printLevel);
0794         massImbalance(:,j)=dE;
0795         E(:,j)=E_el;
0796         fprintf(<span class="string">'%s\n'</span>,[<span class="string">'Checked element '</span> Elements{j}]);  
0797     <span class="keyword">else</span>
0798         <span class="comment">%no need to print out for each element which metabolites have no</span>
0799         <span class="comment">%formula</span>
0800         [massImbalance(:,j),E(:,j)]=<a href="../setupThermoModel/massBalance/checkBalance.html" class="code" title="function [dE,E]=checkBalance(model,element,printLevel)">checkBalance</a>(model,Elements{j},0);
0801         fprintf(<span class="string">'%s\n'</span>,[<span class="string">'Checking element '</span> Elements{j}]);
0802     <span class="keyword">end</span>
0803 <span class="keyword">end</span>
0804 massImbalance(~rxnBool,:)=0;
0805 imBalancedBool=sum(abs(massImbalance'))'~=0;
0806 
0807 imBalancedBool=rxnBool &amp; imBalancedBool;
0808 
0809 imBalancedMass=cell(nRxn,1);
0810 <span class="keyword">for</span> i = 1 : nRxn
0811     imBalancedMass{i,1}=<span class="string">''</span>;   
0812     <span class="keyword">if</span> imBalancedBool(i)
0813         <span class="keyword">for</span> j = 1 : length(Elements)
0814             <span class="keyword">if</span> massImbalance(i,j)~=0
0815                 <span class="keyword">if</span> ~strcmp(imBalancedMass{i,1},<span class="string">''</span>)
0816                     imBalancedMass{i,1} = [imBalancedMass{i,1} <span class="string">', '</span> int2str(massImbalance(i,j)) <span class="string">' '</span> Elements{j}];
0817                 <span class="keyword">else</span>
0818                     imBalancedMass{i,1} = [int2str(massImbalance(i,j)) <span class="string">' '</span> Elements{j}];
0819                 <span class="keyword">end</span>
0820             <span class="keyword">end</span>
0821             
0822         <span class="keyword">end</span>
0823         <span class="keyword">if</span> strfind(imBalancedMass{i,1},<span class="string">'NaN'</span>)
0824             imBalancedMass{i,1}=<span class="string">'NaN'</span>;
0825         <span class="keyword">end</span>
0826     <span class="keyword">end</span>
0827     <span class="keyword">if</span> mod(i,1000)==0
0828         fprintf(<span class="string">'%n\t%s\n'</span>,i,[<span class="string">'reactions checked for '</span> Elements{j} <span class="string">' balance'</span>]);
0829     <span class="keyword">end</span>
0830 <span class="keyword">end</span>
0831 <span class="keyword">if</span> printLevel==-1
0832     firstMissing=0;
0833     <span class="keyword">for</span> p=1:nRxn
0834         <span class="keyword">if</span> ~strcmp(imBalancedMass{p,1},<span class="string">''</span>)
0835             <span class="comment">%at the moment, ignore reactions with a metabolite that have</span>
0836             <span class="comment">%no formula</span>
0837             <span class="keyword">if</span> ~strcmp(imBalancedMass{p,1},<span class="string">'NaN'</span>)
0838                 <span class="keyword">if</span> ~firstMissing
0839                     fid=fopen(<span class="string">'mass_imbalanced_reactions.txt'</span>,<span class="string">'w'</span>);
0840                     fprintf(fid,<span class="string">'%s;%s;%s;%s\n'</span>,<span class="string">'#Rxn'</span>,<span class="string">'rxnAbbr'</span>,<span class="string">'imbalance'</span>,<span class="string">'equation'</span>);
0841 
0842                     warning(<span class="string">'There are mass imbalanced reactions, see mass_imbalanced_reactions.txt'</span>)
0843                     firstMissing=1;
0844                 <span class="keyword">end</span>
0845                 equation=printRxnFormula(model,model.rxns(p),0);
0846                 fprintf(fid,<span class="string">'%s;%s;%s;%s\n'</span>,int2str(p),model.rxns{p},imBalancedMass{p,1},equation{1});
0847                 <span class="keyword">for</span> m=1:size(model.S,1)
0848                     <span class="keyword">if</span> model.S(m,p)~=0
0849                         fprintf(fid,<span class="string">'%s\t%s\t%s\t%s\t%s\n'</span>,int2str(m),model.mets{m},int2str(model.S(m,p)),int2str(E(m)),model.metFormulas{m});
0850                     <span class="keyword">end</span>
0851                 <span class="keyword">end</span>
0852             <span class="keyword">end</span>
0853         <span class="keyword">end</span>
0854     <span class="keyword">end</span>
0855     <span class="keyword">if</span> firstMissing
0856         fclose(fid);
0857     <span class="keyword">end</span>
0858 <span class="keyword">end</span>
0859 <span class="keyword">if</span> printLevel==1
0860     <span class="keyword">for</span> p=1:nRxn
0861         <span class="keyword">if</span> ~strcmp(imBalancedMass{p,1},<span class="string">''</span>)
0862             <span class="comment">%at the moment, ignore reactions with a metabolite that have</span>
0863             <span class="comment">%no formula</span>
0864             <span class="keyword">if</span> ~strcmp(imBalancedMass{p,1},<span class="string">'NaN'</span>)
0865                 equation=printRxnFormula(model,model.rxns(p),0);
0866                 fprintf(<span class="string">'%6s\t%30s\t%10s\t%s\n'</span>,int2str(p),model.rxns{p},imBalancedMass{p,1},equation{1});
0867                 <span class="keyword">if</span> 0
0868                 <span class="keyword">for</span> m=1:size(model.S,1)
0869                     <span class="keyword">if</span> model.S(m,p)~=0
0870                         fprintf(fid,<span class="string">'%s\t%s\t%s\t%s\t%s\n'</span>,int2str(m),model.mets{m},int2str(model.S(m,p)),int2str(E(m)),model.metFormulas{m});
0871                     <span class="keyword">end</span>
0872                 <span class="keyword">end</span>
0873                 <span class="keyword">end</span>
0874             <span class="keyword">end</span>
0875         <span class="keyword">end</span>
0876     <span class="keyword">end</span>
0877 <span class="keyword">end</span>
0878 
0879 <span class="comment">%</span>
0880 <span class="keyword">if</span> nnz(strcmp(<span class="string">''</span>,imBalancedMass))==nRxn
0881     imBalancedMass=[];
0882 <span class="keyword">end</span>
0883 
0884 <span class="comment">% Check for charge balance</span>
0885 imBalancedCharge=[];
0886 firstMissing=0;
0887 <span class="keyword">if</span> isfield(model, <span class="string">'metCharges'</span>)
0888     <span class="keyword">for</span> m=1:nMet
0889         <span class="keyword">if</span> isnan(model.metCharges(m)) &amp;&amp; ~isempty(model.metFormulas{m})
0890             <span class="keyword">if</span> printLevel==1
0891                 fprintf(<span class="string">'%s\t%s\n'</span>,int2str(m),[model.mets{m} <span class="string">' has no charge but has formula.'</span>])
0892                 <span class="keyword">if</span> ~firstMissing
0893                     warning(<span class="string">'model structure must contain model.metCharges field for each metabolite'</span>);
0894                 <span class="keyword">end</span>
0895                 firstMissing=1;
0896             <span class="keyword">end</span>
0897             <span class="keyword">if</span> printLevel==-1
0898                 <span class="keyword">if</span> ~firstMissing
0899                     fid=fopen(<span class="string">'metabolites_without_charge.txt'</span>,<span class="string">'w'</span>);
0900                 <span class="keyword">end</span>
0901                 firstMissing=1;
0902                 fprintf(fid,<span class="string">'%s\t%s\n'</span>,int2str(m),model.mets{m})
0903             <span class="keyword">end</span>
0904         <span class="keyword">else</span>
0905             dC=model.S'*model.metCharges;
0906         <span class="keyword">end</span>
0907     <span class="keyword">end</span>
0908     <span class="keyword">if</span> any(dC(rxnBool))~=0
0909         imBalancedCharge=dC;
0910         imBalancedCharge(~rxnBool)=0;
0911     <span class="keyword">else</span>
0912         imBalancedCharge=[];
0913     <span class="keyword">end</span>
0914 <span class="keyword">end</span>
0915 
0916 <span class="keyword">if</span> printLevel==-1
0917     firstMissing=0;
0918     <span class="keyword">if</span> ~isempty(imBalancedCharge)
0919         <span class="keyword">for</span> q=1:nRxn
0920             <span class="keyword">if</span> model.SIntRxnBool(q) &amp;&amp; dC(q)~=0 &amp;&amp; strcmp(imBalancedMass{p,1},<span class="string">''</span>)
0921                 <span class="keyword">if</span> ~firstMissing
0922                     fid=fopen(<span class="string">'charge_imbalanced_reactions.txt'</span>,<span class="string">'w'</span>);
0923                     warning(<span class="string">'There are charged imbalanced reactions (that are mass balanced), see charge_imbalanced_reactions.txt'</span>)
0924                     firstMissing=1;
0925                 <span class="keyword">end</span>
0926                 equation=printRxnFormula(model,model.rxns(q),0);
0927                 fprintf(fid,<span class="string">'%s\t%s\t%s\n'</span>,int2str(q),model.rxns{q},equation{1});
0928                 <span class="keyword">if</span> 0
0929                     <span class="keyword">for</span> m=1:size(model.S,1)
0930                         <span class="keyword">if</span> model.S(m,q)~=0
0931                             fprintf(fid,<span class="string">'%s\t%15s\t%3s\t%3s\t%s\n'</span>,int2str(m),model.mets{m},int2str(model.S(m,q)),int2str(model.metCharges(m)),model.metFormulas{m});
0932                         <span class="keyword">end</span>
0933                     <span class="keyword">end</span>
0934                 <span class="keyword">end</span>
0935             <span class="keyword">end</span>
0936         <span class="keyword">end</span>
0937         <span class="keyword">if</span> firstMissing
0938             fclose(fid);
0939         <span class="keyword">end</span>
0940     <span class="keyword">end</span>
0941 <span class="keyword">end</span>
0942 
0943 <span class="keyword">if</span> printLevel==1
0944     <span class="keyword">if</span> ~isempty(imBalancedCharge)
0945         fprintf(<span class="string">'%s\n'</span>,<span class="string">'Mass balanced, but charged imbalanced reactions:'</span>)
0946         <span class="keyword">for</span> q=1:nRxn
0947             <span class="keyword">if</span> model.SIntRxnBool(q) &amp;&amp; dC(q)~=0 &amp;&amp; strcmp(imBalancedMass{p,1},<span class="string">''</span>)
0948                 equation=printRxnFormula(model,model.rxns(q),0);
0949                 fprintf(<span class="string">'%s\t%s\t%s\n'</span>,int2str(q),model.rxns{q},equation{1});
0950                 <span class="keyword">if</span> 1
0951                     <span class="keyword">for</span> m=1:size(model.S,1)
0952                         <span class="keyword">if</span> model.S(m,q)~=0
0953                             fprintf(<span class="string">'%s\t%15s\t%3s\t%3s\t%s\n'</span>,int2str(m),model.mets{m},int2str(model.S(m,q)),int2str(model.metCharges(m)),model.metFormulas{m});
0954                         <span class="keyword">end</span>
0955                     <span class="keyword">end</span>
0956                 <span class="keyword">end</span>
0957             <span class="keyword">end</span>
0958         <span class="keyword">end</span>
0959     <span class="keyword">end</span>
0960 <span class="keyword">end</span>
0961 
0962 <span class="keyword">if</span> ~isempty(imBalancedCharge)
0963     imBalancedBool = imBalancedBool |  imBalancedCharge~=0;
0964 <span class="keyword">end</span>
0965 <span class="keyword">end</span>
0966</pre></div>
<hr><address>Generated on Fri 20-May-2011 17:06:05 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2003</address>
</body>
</html>