<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><script type="text/javascript" src="https://cdn.rawgit.com/opencobra/cobratoolbox/gh-pages/latest/_static/js/iframeResizer.contentWindow.min.js"></script><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="generator" content="MATLAB R2016a"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><title>Testing basic properties of a metabolic model (aka sanity checks)</title><style type="text/css">
* {margin: 0; padding: 0;}
body {text-align: start; line-height: 17.234px; min-height: 0px; white-space: normal; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Menlo, monospace; font-style: normal; font-size: 14px; font-weight: normal; text-decoration: none; white-space: normal; }
h1, h2 {font-weight: normal;}
.content { padding: 30px; }

.S0 { margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S1 { line-height: 26.4px; min-height: 24px; white-space: normal; color: rgb(213, 80, 0); font-family: Helvetica, Arial, sans-serif; font-size: 22px; white-space: normal; margin-left: 4px; margin-top: 3px; margin-bottom: 15px; margin-right: 10px;  }
.S2 { min-height: 0px; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S3 { line-height: 21px; min-height: 17px; white-space: normal; font-family: Helvetica, Arial, sans-serif; white-space: normal; margin-left: 4px; margin-top: 2px; margin-bottom: 9px; margin-right: 10px;  }
.S4 { min-height: 0px; font-weight: bold; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S5 { line-height: 20.576px; min-height: 20px; white-space: normal; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; white-space: normal; margin-left: 4px; margin-top: 15px; margin-bottom: 9px; margin-right: 10px;  }
.S6 { font-family: Helvetica, Arial, sans-serif; margin-left: 0px; margin-top: 10px; margin-bottom: 20px; margin-right: 0px;  }
.S7 { text-align: left; line-height: 21px; white-space: normal; white-space: normal; margin-left: 56px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S8 { line-height: 20.576px; min-height: 20px; white-space: normal; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: bold; white-space: normal; margin-left: 4px; margin-top: 3px; margin-bottom: 9px; margin-right: 10px;  }
.S9 { margin-left: 3px; margin-top: 10px; margin-bottom: 10px; margin-right: 3px;  }
.S10 { line-height: 15.5927px; min-height: 18px; white-space: nowrap; font-size: 12.6667px; white-space: nowrap; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S11 { min-height: 0px; white-space: normal; white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 45px;  }
.S12 { line-height: 21px; min-height: 17px; white-space: normal; font-family: Helvetica, Arial, sans-serif; white-space: normal; margin-left: 4px; margin-top: 10px; margin-bottom: 9px; margin-right: 10px;  }
.S13 { min-height: 0px; white-space: normal; white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S14 { min-height: 0px; white-space: normal; color: rgb(160, 32, 240); white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S15 { min-height: 0px; white-space: normal; color: rgb(34, 139, 34); white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 45px;  }
.S16 { min-height: 0px; font-family: monospace; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S17 { min-height: 0px; color: rgb(0, 95, 206); margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S18 { margin-left: 3px; margin-top: 10px; margin-bottom: 4px; margin-right: 3px;  }
.S19 { min-height: 0px; white-space: normal; color: rgb(160, 32, 240); white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 45px;  }
.S20 { min-height: 0px; white-space: normal; color: rgb(0, 0, 255); white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 0px;  }
.S21 { min-height: 0px; white-space: normal; color: rgb(0, 0, 255); white-space: normal; margin-left: 0px; margin-top: 0px; margin-bottom: 0px; margin-right: 45px;  }

.LineNodeBlock {margin: 10px 0 10px 0;}
.LineNodeBlock+.paragraphNode {margin-top: 10px;}
.lineNode {padding-left: 10px; background-color: #F7F7F7; border-left: 1px solid #E9E9E9; border-right: 1px solid #E9E9E9;}
.inlineWrapper:first-child .lineNode,.inlineWrapper.outputs+.inlineWrapper .lineNode {padding-top: 5px; border-top: 1px solid #E9E9E9;}
.inlineWrapper:last-child .lineNode,.inlineWrapper.outputs .lineNode {padding-bottom: 5px; border-bottom: 1px solid #E9E9E9;}
.lineNode .textBox {white-space: normal;}
</style></head><body><div class = "content"><div class = 'SectionBlock containment active'><h1 class = "S1"><span class = "S2">Testing basic properties of a metabolic model (aka sanity checks)</span></h1><p class = "S3"><span class = "S4">Author(s): Ines Thiele, Ronan M. T. Fleming, Systems Biochemistry Group, LCSB, University of Luxembourg.</span></p><p class = "S3"><span class = "S4">Reviewer(s): Almut Heinken, LCSB, University of Luxembourg.</span></p><p class = "S3"><span class = "S2">In this tutorial, we show how test for basic modeling properties of a metabolic model. The tutorial was developed during the construction of the generic human metabolic model, Recon 3D [1] and can be applied to Recon 3D derived condition- and cell-type specific models, to the previous generic human reconstruction, Recon2, as well as other metabolic models.</span></p><h2 class = "S5"><span class = "S2">Content:</span></h2><p class = "S3"><span class = "S2">The tests include:</span></p><ul class = "S6"><li class = "S7"><span class = "S0">leak test</span></li><li class = "S7"><span class = "S0">production of protons from nothing as well as from water, and/or oxygen alone</span></li><li class = "S7"><span class = "S0">production of matter when atp hydrolysis reaction is allowed to work but all uptakes are closed</span></li><li class = "S7"><span class = "S0">production of too much ATP from glucose under aerobic condition</span></li><li class = "S7"><span class = "S0">duplicated reactions</span></li><li class = "S7"><span class = "S0">empty colmuns in the model.rxnGeneMat</span></li><li class = "S7"><span class = "S0">the single gene deletion analysis runs smoothly</span></li><li class = "S7"><span class = "S0">ATP yield from different carbon sources</span></li><li class = "S7"><span class = "S0">metabolic objective functions</span></li><li class = "S7"><span class = "S0">flux consistency</span></li><li class = "S7"><span class = "S0">demand reactions with negative lower bound (should not occur based on definition of demand reactions)</span></li><li class = "S7"><span class = "S0">consistency of model.rev, which defines reaction reversibility, and the set values for the lower bounds on reactions. </span></li></ul><p class = "S3"><span class = "S2">All results are stored in a table ('TableChecks').</span></p></div><p class = "S0"></p><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2">EQUIPMENT SETUP</span></h2><p class = "S3"><span class = "S2">If necessary, initialize the cobra toolbox:</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">initCobraToolbox</span></p></div></div><p class = "S12"><span class = "S2">For solving line</span><span class = "S2">ar programming problems in FBA analysis, certain solvers are required:</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">changeCobraSolver (</span><span class = "S14">'glpk'</span><span class = "S13">, </span><span class = "S14">'all'</span><span class = "S11">, 1);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S15">%Uncomment if you don't want to use glpk.</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S15">%changeCobraSolver ('ibm_cplex', 'all', 1); </span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S15">%changeCobraSolver ('tomlab_cplex', 'all', 1);</span></p></div></div><p class = "S12"><span class = "S2">This tutoria</span><span class = "S2">l can be ru</span><span class = "S2">n </span><span class = "S2">with </span><span class = "S16">'glpk</span><span class = "S16">'</span><span class = "S2"> package as linear programming solver, which does not require additional instalation and configuration. However, for the analysis of large models, such as Recon 3, it is not recommended to use </span><span class = "S16">'glpk</span><span class = "S16">'</span><span class = "S2"> but rather industrial strenght solvers, such as the </span><span class = "S16">'gurobi'</span><span class = "S2"> package. For detail information, refer to the solver instalation guide: </span><a href = 'https://github.com/opencobra/cobratoolbox/blob/master/docs/source/installation/solvers.md'><span class = "S0">https://github.com/opencobra/cobratoolbox/blob/master/docs/source/installation/solvers.md</span></a></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">warning </span><span class = "S19">off MATLAB:subscripting:noSubscriptsSpecified</span></p></div></div></div><p class = "S0"></p><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2">PROCEDURE</span></h2><p class = "S3"><span class = "S2">Before proceeding with the simulations, the path for the model needs to be set up. In thi</span><span class = "S2">s tutorial, the used</span><span class = "S2"> model is the generic model of human metabolism, Recon 3 [1]. If Recon 3 is not available, please use Recon 2.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelFileName = </span><span class = "S14">'Recon2.0model.mat'</span><span class = "S13">; </span><span class = "S15">%Replace if you want to load Recon3D</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelDirectory = getDistributedModelFolder(modelFileName); </span><span class = "S15">%Look up the folder for the distributed Models.</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelFileName= [modelDirectory filesep modelFileName]; </span><span class = "S15">% Get the full path. Necessary to be sure, that the right model is loaded</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">model = readCbModel(modelFileName);</span></p></div></div></div><p class = "S0"></p><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2">Model Harmonization</span></h2><p class = "S3"><span class = "S2">Replace reaction abbreviation for the ATP hydrolysis (DM_atp_c_) and Biomass reaction used differently in various models.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'ATPM'</span><span class = "S13">)))={</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">};</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'ATPhyd'</span><span class = "S13">)))={</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">};</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'DM_atp(c)'</span><span class = "S13">)))={</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">};</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'EX_biomass_reaction'</span><span class = "S13">)))={</span><span class = "S14">'biomass_reaction'</span><span class = "S11">};</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'EX_biomass_maintenance'</span><span class = "S13">)))={</span><span class = "S14">'biomass_maintenance'</span><span class = "S11">};</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns(find(ismember(model.rxns,</span><span class = "S14">'EX_biomass_maintenance_noTrTr'</span><span class = "S13">)))={</span><span class = "S14">'biomass_maintenance_noTrTr'</span><span class = "S11">};</span></p></div></div><p class = "S12"><span class = "S2">Set lower bound of the biomass reaction to 0.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.lb(find(ismember(model.rxns,</span><span class = "S14">'biomass_reaction'</span><span class = "S11">)))=0;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.lb(find(ismember(model.rxns,</span><span class = "S14">'biomass_maintenance_noTrTr'</span><span class = "S11">)))=0;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.lb(find(ismember(model.rxns,</span><span class = "S14">'biomass_maintenance'</span><span class = "S11">)))=0;</span></p></div></div><p class = "S12"><span class = "S2">Harmonize different use of brackets.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns = regexprep(model.rxns,</span><span class = "S14">'\('</span><span class = "S13">,</span><span class = "S14">'\['</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns = regexprep(model.rxns,</span><span class = "S14">'\)'</span><span class = "S13">,</span><span class = "S14">'\]'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns = regexprep(model.rxns,</span><span class = "S14">'Ex_'</span><span class = "S13">,</span><span class = "S14">'EX_'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns = regexprep(model.rxns,</span><span class = "S14">'Sink_'</span><span class = "S13">,</span><span class = "S14">'sink_'</span><span class = "S11">); </span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">model.rxns = regexprep(model.rxns,</span><span class = "S14">'-'</span><span class = "S13">,</span><span class = "S14">'_'</span><span class = "S11">); </span></p></div></div><p class = "S12"><span class = "S2">Define some parameters that we will need.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = 1;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">tol = 1e-6;</span></p></div></div><p class = "S12"><span class = "S2">Define the closed model. Here, we will set to zero the lower bounds of all reactions that represent exchange and siphon ('sink') reactions, or that contain only one entry in the column of the S matrix. The upper bound of those reactions is set to 1000 (i.e., infinity). Note that this overwrites any constraints on those reactions that may be present in a condition- and cell-type specific model.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = model;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelexchanges1 = strmatch(</span><span class = "S14">'Ex_'</span><span class = "S11">,modelClosed.rxns);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelexchanges4 = strmatch(</span><span class = "S14">'EX_'</span><span class = "S11">,modelClosed.rxns);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelexchanges2 = strmatch(</span><span class = "S14">'DM_'</span><span class = "S11">,modelClosed.rxns);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelexchanges3 = strmatch(</span><span class = "S14">'sink_'</span><span class = "S11">,modelClosed.rxns);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">selExc = (find( full((sum(abs(modelClosed.S)==1,1) ==1) &amp; (sum(modelClosed.S~=0) == 1))))';</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11"></span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelexchanges = unique([modelexchanges1;modelexchanges2;modelexchanges3;modelexchanges4;selExc]);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed.lb(find(ismember(modelClosed.rxns,modelClosed.rxns(modelexchanges))))=0;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed.ub(find(ismember(modelClosed.rxns,modelClosed.rxns(modelexchanges))))=1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosedOri = modelClosed;</span></p></div></div></div><p class = "S0"></p><div class = 'SectionBlock containment'><h2 class = "S8"><span class = "S2">Start with tests.</span></h2><p class = "S3"><span class = "S2">Perform leak test, i.e., whether the closed model can produce any exchanged metabolite, as defined in the model, from nothing. </span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">[LeakRxns,modelTested,LeakRxnsFluxVector] = fastLeakTest(modelClosed,modelClosed.rxns(selExc),</span><span class = "S14">'false'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'fastLeakTest 1'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">length(LeakRxns)&gt;0</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    warning(</span><span class = "S14">'model leaks metabolites!'</span><span class = "S11">)</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Model leaks metabolites!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Leak free!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if something leaks when demand reactions for each metabolite in the model are added. Note that this step is time consuming.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">[LeakRxnsDM,modelTestedDM,LeakRxnsFluxVectorDM] = fastLeakTest(modelClosed,modelClosed.rxns(selExc),</span><span class = "S14">'true'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11"></span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'fastLeakTest 2 - add demand reactions for each metabolite in the model'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">length(LeakRxnsDM)&gt;0</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Model leaks metabolites when demand reactions are added!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Leak free when demand reactions are added!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the model produces energy from water!</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeObjective(modelClosed,</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeRxnBounds(modelClosedATP,</span><span class = "S14">'DM_atp_c_'</span><span class = "S13">,0,</span><span class = "S14">'l'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeRxnBounds(modelClosedATP,</span><span class = "S14">'EX_h2o[e]'</span><span class = "S13">,-1,</span><span class = "S14">'l'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">FBA3=optimizeCbModel(modelClosedATP);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Exchanges, sinks, and demands have  lb = 0, except h2o'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">abs(FBA3.f) &gt; 1e-6</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model produces energy from water!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model DOES NOT produce energy from water!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the model produces energy from water and oxygen!</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeObjective(modelClosed,</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeRxnBounds(modelClosedATP,</span><span class = "S14">'DM_atp_c_'</span><span class = "S13">,0,</span><span class = "S14">'l'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeRxnBounds(modelClosedATP,</span><span class = "S14">'EX_h2o[e]'</span><span class = "S13">,-1,</span><span class = "S14">'l'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosedATP = changeRxnBounds(modelClosedATP,</span><span class = "S14">'EX_o2[e]'</span><span class = "S13">,-1,</span><span class = "S14">'l'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11"></span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">FBA6=optimizeCbModel(modelClosedATP);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Exchanges, sinks, and demands have  lb = 0, except h2o and o2'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">abs(FBA6.f) &gt; 1e-6</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model produces energy from water and oxygen!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model DOES NOT produce energy from water and oxygen!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the model produces matter when atp demand is reversed!</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = changeObjective(modelClosed,</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.lb(find(ismember(modelClosed.rxns,</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">))) = -1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">FBA = optimizeCbModel(modelClosed);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Exchanges, sinks, and demands have  lb = 0, allow DM_atp_c_ to be reversible'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">abs(FBA.f) &gt; 1e-6</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model produces matter when atp demand is reversed!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model DOES NOT produce matter when atp demand is reversed!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the model has flux through h[m] demand !</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = addDemandReaction(modelClosed,</span><span class = "S14">'h[m]'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = changeObjective(modelClosed,</span><span class = "S14">'DM_h[m]'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.ub(find(ismember(modelClosed.rxns,</span><span class = "S14">'DM_h[m]'</span><span class = "S11">))) = 1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">FBA = optimizeCbModel(modelClosed,</span><span class = "S14">'max'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Exchanges, sinks, and demands have  lb = 0, test flux through DM_h[m] (max)'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">abs(FBA.f) &gt; 1e-6</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model has flux through h[m] demand (max)!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model has NO flux through h[m] demand (max)!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the  model has flux through h[c] demand !</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = addDemandReaction(modelClosed,</span><span class = "S14">'h[c]'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = changeObjective(modelClosed,</span><span class = "S14">'DM_h[c]'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.ub(find(ismember(modelClosed.rxns,</span><span class = "S14">'DM_h[c]'</span><span class = "S11">))) = 1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">FBA = optimizeCbModel(modelClosed,</span><span class = "S14">'max'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Exchanges, sinks, and demands have  lb = 0, test flux through DM_h[c] (max)'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">abs(FBA.f) &gt; 1e-6</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model has flux through h[c] demand (max)!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'model has NO flux through h[c] demand (max)!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test if the  m</span><span class = "S2">odel produces too much atp demand from glucose under aerobic condition. Also consider using the tutorial testModelATPYield to test if the correct ATP yield from different carbon sources can be realized by the model.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">modelClosed = modelClosedOri;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed = changeObjective(modelClosed,</span><span class = "S14">'DM_atp_c_'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.lb(find(ismember(modelClosed.rxns,</span><span class = "S14">'EX_o2[e]'</span><span class = "S11">))) = -1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.lb(find(ismember(modelClosed.rxns,</span><span class = "S14">'EX_h2o[e]'</span><span class = "S11">))) = -1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.ub(find(ismember(modelClosed.rxns,</span><span class = "S14">'EX_h2o[e]'</span><span class = "S11">))) = 1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">modelClosed.ub(find(ismember(modelClosed.rxns,</span><span class = "S14">'EX_co2[e]'</span><span class = "S11">))) = 1000;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">FBAOri = optimizeCbModel(modelClosed,</span><span class = "S14">'max'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11"></span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'ATP yield '</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S13">abs(FBAOri.f) &gt; 31 </span><span class = "S15">% this is the theoretical value</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">     TableChecks{cnt,2} = </span><span class = "S14">'model produces too much atp demand from glc!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">   TableChecks{cnt,2} =</span><span class = "S14">'model DOES NOT produce too much atp demand from glc!'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">    Test metab</span><span class = "S2">olic objective functions with open sinks. Note this step is time consuming and may only work reliably on Recon 3D derived models due to different usage of abbreviations.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Test metabolic objective functions with open sinks'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S13">1 </span><span class = "S15">% perform test function</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    [TestSolution,TestSolutionNameOpenSinks, TestedRxnsSinks, PercSinks] = Test4HumanFctExt(model,</span><span class = "S14">'all'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = strcat(</span><span class = "S14">'Done. See variable TestSolutionNameOpenSinks for results. The model passes '</span><span class = "S13">, num2str(length(find(abs(TestSolution)&gt;tol))),</span><span class = "S14">' out of '</span><span class = "S13">, num2str(length(TestSolution)), </span><span class = "S14">'tests'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Not performed.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt =  cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Test metabolic </span><span class = "S2">objective functions with closed sinks (lb). Note this step is time consuming and may only work reliably on Recon 3D derived models due to different usage of abbreviations.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Test metabolic objective functions with closed sinks (lb)'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S13">1 </span><span class = "S15">% perform test functions</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    [TestSolution,TestSolutionNameClosedSinks, TestedRxnsClosedSinks, PercClosedSinks] = test4HumanFctExt(model,</span><span class = "S14">'all'</span><span class = "S11">,0);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = strcat(</span><span class = "S14">'Done. See variable TestSolutionNameClosedSinks for results. The model passes '</span><span class = "S13">, num2str(length(find(abs(TestSolution)&gt;tol))),</span><span class = "S14">' out of '</span><span class = "S13">, num2str(length(TestSolution)), </span><span class = "S14">'tests'</span><span class = "S11">);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Not performed.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt =  cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Compute ATP yie</span><span class = "S2">ld. This test is identical to the material covered in the tutorial testModelATPYield.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Compute ATP yield'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S13">1 </span><span class = "S15">% test ATP yield</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">    [Table_csources, TestedRxns, Perc] = testATPYieldFromCsources(model);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Done. See variable Table_csources for results.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Not performed.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Check for dupl</span><span class = "S2">icated reactions in the model.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Check duplicated reactions'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">method=</span><span class = "S14">'FR'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">removeFlag=0;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">[modelOut,removedRxnInd, keptRxnInd] = checkDuplicateRxn(model,method,removeFlag,0);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">isempty(removedRxnInd)</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'No duplicated reactions in model.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Duplicated reactions in model.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Check empty co</span><span class = "S2">lumns in 'model.rxnGeneMat'.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Check empty columns in rxnGeneMat'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">E = find(sum(model.rxnGeneMat)==0);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">isempty(E)</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'No empty columns in rxnGeneMat.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Empty columns in rxnGeneMat.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Check that dem</span><span class = "S2">and reactions have a lb &gt;= 0.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Check that demand reactions have a lb &gt;= 0'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">DMlb = find(model.lb(strmatch(</span><span class = "S14">'DM_'</span><span class = "S11">,model.rxns))&lt;0);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">isempty(DMlb)</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'No demand reaction can have flux in backward direction.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Demand reaction can have flux in backward direction.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Check whether </span><span class = "S2">singleGeneDeletion runs smoothly.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Check whether singleGeneDeletion runs smoothly'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">try</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">    [grRatio,grRateKO,grRateWT,hasEffect,delRxns,fluxSolution] = singleGeneDeletion(model);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'singleGeneDeletion finished without problems.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">catch</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'There are problems with singleGeneDeletion.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Check for flux</span><span class = "S2"> consistency.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">TableChecks{cnt,1} = </span><span class = "S14">'Check for flux consistency'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">param.epsilon=1e-4;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">param.modeFlag=0;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S15">%param.method='null_fastcc';</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">param.method=</span><span class = "S14">'fastcc'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">printLevel = 1;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">[fluxConsistentMetBool,fluxConsistentRxnBool,fluxInConsistentMetBool,fluxInConsistentRxnBool,model] = findFluxConsistentSubset(model,param,printLevel);</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S20">if </span><span class = "S11">isempty(find(fluxInConsistentRxnBool))</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Model is flux consistent.'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">else</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">    TableChecks{cnt,2} = </span><span class = "S14">'Model is NOT flux consistent'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S21">end</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">cnt = cnt + 1;</span></p></div></div><p class = "S12"><span class = "S2">Display all re</span><span class = "S2">sults.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">TableChecks</span></p></div></div><p class = "S12"><span class = "S2">Save all re</span><span class = "S2">sults.</span></p><div class = 'LineNodeBlock contiguous'><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S13">resultsFileName = </span><span class = "S14">'TestResults'</span><span class = "S11">;</span></p></div><div class = 'inlineWrapper'><p class = "S10 lineNode"><span class = "S11">save(strcat(resultsFileName,'.mat'));</span></p></div></div><h2 class = "S5"><span class = "S2">References</span></h2><p class = "S3"><span class = "S2"> [1] Brunk, E. et al. Recon 3D: A resource enabling a three-dimensional view of gene variation in human metabolism. (submitted) 2017.</span></p></div></div>
<!-- 
##### SOURCE BEGIN #####
%% Testing basic properties of a metabolic model (aka sanity checks)
% *Author(s): Ines Thiele, Ronan M. T. Fleming, Systems Biochemistry Group, 
% LCSB, University of Luxembourg.*
% 
% *Reviewer(s): Almut Heinken, LCSB, University of Luxembourg.*
% 
% In this tutorial, we show how test for basic modeling properties of a metabolic 
% model. The tutorial was developed during the construction of the generic human 
% metabolic model, Recon 3D [1] and can be applied to Recon 3D derived condition- 
% and cell-type specific models, to the previous generic human reconstruction, 
% Recon2, as well as other metabolic models.
%% Content:
% The tests include:
% 
% * leak test
% * production of protons from nothing as well as from water, and/or oxygen 
% alone
% * production of matter when atp hydrolysis reaction is allowed to work but 
% all uptakes are closed
% * production of too much ATP from glucose under aerobic condition
% * duplicated reactions
% * empty colmuns in the model.rxnGeneMat
% * the single gene deletion analysis runs smoothly
% * ATP yield from different carbon sources
% * metabolic objective functions
% * flux consistency
% * demand reactions with negative lower bound (should not occur based on definition 
% of demand reactions)
% * consistency of model.rev, which defines reaction reversibility, and the 
% set values for the lower bounds on reactions. 
% 
% All results are stored in a table ('TableChecks').
%% EQUIPMENT SETUP
% If necessary, initialize the cobra toolbox:

initCobraToolbox
%% 
% For solving linear programming problems in FBA analysis, certain solvers 
% are required:

changeCobraSolver ('glpk', 'all', 1);
%Uncomment if you don't want to use glpk.
%changeCobraSolver ('ibm_cplex', 'all', 1); 
%changeCobraSolver ('tomlab_cplex', 'all', 1);
%% 
% This tutorial can be run with |'glpk'| package as linear programming solver, 
% which does not require additional instalation and configuration. However, for 
% the analysis of large models, such as Recon 3, it is not recommended to use 
% |'glpk'| but rather industrial strenght solvers, such as the |'gurobi'| package. 
% For detail information, refer to the solver instalation guide: <https://github.com/opencobra/cobratoolbox/blob/master/docs/source/installation/solvers.md 
% https://github.com/opencobra/cobratoolbox/blob/master/docs/source/installation/solvers.md>

warning off MATLAB:subscripting:noSubscriptsSpecified
%% PROCEDURE
% Before proceeding with the simulations, the path for the model needs to be 
% set up. In this tutorial, the used model is the generic model of human metabolism, 
% Recon 3 [1]. If Recon 3 is not available, please use Recon 2.

modelFileName = 'Recon2.0model.mat'; %Replace if you want to load Recon3D
modelDirectory = getDistributedModelFolder(modelFileName); %Look up the folder for the distributed Models.
modelFileName= [modelDirectory filesep modelFileName]; % Get the full path. Necessary to be sure, that the right model is loaded
model = readCbModel(modelFileName);
%% Model Harmonization
% Replace reaction abbreviation for the ATP hydrolysis (DM_atp_c_) and Biomass 
% reaction used differently in various models.

model.rxns(find(ismember(model.rxns,'ATPM')))={'DM_atp_c_'};
model.rxns(find(ismember(model.rxns,'ATPhyd')))={'DM_atp_c_'};
model.rxns(find(ismember(model.rxns,'DM_atp(c)')))={'DM_atp_c_'};
model.rxns(find(ismember(model.rxns,'EX_biomass_reaction')))={'biomass_reaction'};
model.rxns(find(ismember(model.rxns,'EX_biomass_maintenance')))={'biomass_maintenance'};
model.rxns(find(ismember(model.rxns,'EX_biomass_maintenance_noTrTr')))={'biomass_maintenance_noTrTr'};
%% 
% Set lower bound of the biomass reaction to 0.

model.lb(find(ismember(model.rxns,'biomass_reaction')))=0;
model.lb(find(ismember(model.rxns,'biomass_maintenance_noTrTr')))=0;
model.lb(find(ismember(model.rxns,'biomass_maintenance')))=0;
%% 
% Harmonize different use of brackets.

model.rxns = regexprep(model.rxns,'\(','\[');
model.rxns = regexprep(model.rxns,'\)','\]');
model.rxns = regexprep(model.rxns,'Ex_','EX_');
model.rxns = regexprep(model.rxns,'Sink_','sink_'); 
model.rxns = regexprep(model.rxns,'-','_'); 
%% 
% Define some parameters that we will need.

cnt = 1;
tol = 1e-6;
%% 
% Define the closed model. Here, we will set to zero the lower bounds of 
% all reactions that represent exchange and siphon ('sink') reactions, or that 
% contain only one entry in the column of the S matrix. The upper bound of those 
% reactions is set to 1000 (i.e., infinity). Note that this overwrites any constraints 
% on those reactions that may be present in a condition- and cell-type specific 
% model.

modelClosed = model;
modelexchanges1 = strmatch('Ex_',modelClosed.rxns);
modelexchanges4 = strmatch('EX_',modelClosed.rxns);
modelexchanges2 = strmatch('DM_',modelClosed.rxns);
modelexchanges3 = strmatch('sink_',modelClosed.rxns);
selExc = (find( full((sum(abs(modelClosed.S)==1,1) ==1) & (sum(modelClosed.S~=0) == 1))))';

modelexchanges = unique([modelexchanges1;modelexchanges2;modelexchanges3;modelexchanges4;selExc]);
modelClosed.lb(find(ismember(modelClosed.rxns,modelClosed.rxns(modelexchanges))))=0;
modelClosed.ub(find(ismember(modelClosed.rxns,modelClosed.rxns(modelexchanges))))=1000;
modelClosedOri = modelClosed;
%% Start with tests.
% Perform leak test, i.e., whether the closed model can produce any exchanged 
% metabolite, as defined in the model, from nothing. 

modelClosed = modelClosedOri;
[LeakRxns,modelTested,LeakRxnsFluxVector] = fastLeakTest(modelClosed,modelClosed.rxns(selExc),'false');
TableChecks{cnt,1} = 'fastLeakTest 1';
if length(LeakRxns)>0
    warning('model leaks metabolites!')
    TableChecks{cnt,2} = 'Model leaks metabolites!';
else
    TableChecks{cnt,2} = 'Leak free!';
end
cnt = cnt + 1;
%% 
% Test if something leaks when demand reactions for each metabolite in the 
% model are added. Note that this step is time consuming.

modelClosed = modelClosedOri;
[LeakRxnsDM,modelTestedDM,LeakRxnsFluxVectorDM] = fastLeakTest(modelClosed,modelClosed.rxns(selExc),'true');

TableChecks{cnt,1} = 'fastLeakTest 2 - add demand reactions for each metabolite in the model';
if length(LeakRxnsDM)>0
    TableChecks{cnt,2} = 'Model leaks metabolites when demand reactions are added!';
else
    TableChecks{cnt,2} = 'Leak free when demand reactions are added!';
end
cnt = cnt + 1;
%% 
% Test if the model produces energy from water!

modelClosed = modelClosedOri;
modelClosedATP = changeObjective(modelClosed,'DM_atp_c_');
modelClosedATP = changeRxnBounds(modelClosedATP,'DM_atp_c_',0,'l');
modelClosedATP = changeRxnBounds(modelClosedATP,'EX_h2o[e]',-1,'l');
FBA3=optimizeCbModel(modelClosedATP);
TableChecks{cnt,1} = 'Exchanges, sinks, and demands have  lb = 0, except h2o';
if abs(FBA3.f) > 1e-6
    TableChecks{cnt,2} = 'model produces energy from water!';
else
    TableChecks{cnt,2} = 'model DOES NOT produce energy from water!';
end
cnt = cnt + 1;
%% 
% Test if the model produces energy from water and oxygen!

modelClosed = modelClosedOri;
modelClosedATP = changeObjective(modelClosed,'DM_atp_c_');
modelClosedATP = changeRxnBounds(modelClosedATP,'DM_atp_c_',0,'l');
modelClosedATP = changeRxnBounds(modelClosedATP,'EX_h2o[e]',-1,'l');
modelClosedATP = changeRxnBounds(modelClosedATP,'EX_o2[e]',-1,'l');

FBA6=optimizeCbModel(modelClosedATP);
TableChecks{cnt,1} = 'Exchanges, sinks, and demands have  lb = 0, except h2o and o2';
if abs(FBA6.f) > 1e-6
    TableChecks{cnt,2} = 'model produces energy from water and oxygen!';
else
    TableChecks{cnt,2} = 'model DOES NOT produce energy from water and oxygen!';
end
cnt = cnt + 1;
%% 
% Test if the model produces matter when atp demand is reversed!

modelClosed = modelClosedOri;
modelClosed = changeObjective(modelClosed,'DM_atp_c_');
modelClosed.lb(find(ismember(modelClosed.rxns,'DM_atp_c_'))) = -1000;
FBA = optimizeCbModel(modelClosed);
TableChecks{cnt,1} = 'Exchanges, sinks, and demands have  lb = 0, allow DM_atp_c_ to be reversible';
if abs(FBA.f) > 1e-6
    TableChecks{cnt,2} = 'model produces matter when atp demand is reversed!';
else
    TableChecks{cnt,2} = 'model DOES NOT produce matter when atp demand is reversed!';
end
cnt = cnt + 1;
%% 
% Test if the model has flux through h[m] demand !

modelClosed = modelClosedOri;
modelClosed = addDemandReaction(modelClosed,'h[m]');
modelClosed = changeObjective(modelClosed,'DM_h[m]');
modelClosed.ub(find(ismember(modelClosed.rxns,'DM_h[m]'))) = 1000;
FBA = optimizeCbModel(modelClosed,'max');
TableChecks{cnt,1} = 'Exchanges, sinks, and demands have  lb = 0, test flux through DM_h[m] (max)';
if abs(FBA.f) > 1e-6
    TableChecks{cnt,2} = 'model has flux through h[m] demand (max)!';
else
    TableChecks{cnt,2} = 'model has NO flux through h[m] demand (max)!';
end
cnt = cnt + 1;
%% 
% Test if the  model has flux through h[c] demand !

modelClosed = modelClosedOri;
modelClosed = addDemandReaction(modelClosed,'h[c]');
modelClosed = changeObjective(modelClosed,'DM_h[c]');
modelClosed.ub(find(ismember(modelClosed.rxns,'DM_h[c]'))) = 1000;
FBA = optimizeCbModel(modelClosed,'max');
TableChecks{cnt,1} = 'Exchanges, sinks, and demands have  lb = 0, test flux through DM_h[c] (max)';
if abs(FBA.f) > 1e-6
    TableChecks{cnt,2} = 'model has flux through h[c] demand (max)!';
else
    TableChecks{cnt,2} = 'model has NO flux through h[c] demand (max)!';
end
cnt = cnt + 1;
%% 
% Test if the  model produces too much atp demand from glucose under aerobic 
% condition. Also consider using the tutorial testModelATPYield to test if the 
% correct ATP yield from different carbon sources can be realized by the model.

modelClosed = modelClosedOri;
modelClosed = changeObjective(modelClosed,'DM_atp_c_');
modelClosed.lb(find(ismember(modelClosed.rxns,'EX_o2[e]'))) = -1000;
modelClosed.lb(find(ismember(modelClosed.rxns,'EX_h2o[e]'))) = -1000;
modelClosed.ub(find(ismember(modelClosed.rxns,'EX_h2o[e]'))) = 1000;
modelClosed.ub(find(ismember(modelClosed.rxns,'EX_co2[e]'))) = 1000;
FBAOri = optimizeCbModel(modelClosed,'max');

TableChecks{cnt,1} = 'ATP yield ';
if abs(FBAOri.f) > 31 % this is the theoretical value
     TableChecks{cnt,2} = 'model produces too much atp demand from glc!';
else
   TableChecks{cnt,2} ='model DOES NOT produce too much atp demand from glc!';
end
cnt = cnt + 1;
%% 
%     Test metabolic objective functions with open sinks. Note this step 
% is time consuming and may only work reliably on Recon 3D derived models due 
% to different usage of abbreviations.

TableChecks{cnt,1} = 'Test metabolic objective functions with open sinks';
if 1 % perform test function
    [TestSolution,TestSolutionNameOpenSinks, TestedRxnsSinks, PercSinks] = Test4HumanFctExt(model,'all');
    TableChecks{cnt,2} = strcat('Done. See variable TestSolutionNameOpenSinks for results. The model passes ', num2str(length(find(abs(TestSolution)>tol))),' out of ', num2str(length(TestSolution)), 'tests');
else
    TableChecks{cnt,2} = 'Not performed.';
end
cnt =  cnt + 1;
%% 
% Test metabolic objective functions with closed sinks (lb). Note this step 
% is time consuming and may only work reliably on Recon 3D derived models due 
% to different usage of abbreviations.

TableChecks{cnt,1} = 'Test metabolic objective functions with closed sinks (lb)';
if 1 % perform test functions
    [TestSolution,TestSolutionNameClosedSinks, TestedRxnsClosedSinks, PercClosedSinks] = test4HumanFctExt(model,'all',0);
    TableChecks{cnt,2} = strcat('Done. See variable TestSolutionNameClosedSinks for results. The model passes ', num2str(length(find(abs(TestSolution)>tol))),' out of ', num2str(length(TestSolution)), 'tests');
else
    TableChecks{cnt,2} = 'Not performed.';
end
cnt =  cnt + 1;
%% 
% Compute ATP yield. This test is identical to the material covered in the 
% tutorial testModelATPYield.

TableChecks{cnt,1} = 'Compute ATP yield';
if 1 % test ATP yield
    [Table_csources, TestedRxns, Perc] = testATPYieldFromCsources(model);
    TableChecks{cnt,2} = 'Done. See variable Table_csources for results.';
else
    TableChecks{cnt,2} = 'Not performed.';
end
cnt = cnt + 1;
%% 
% Check for duplicated reactions in the model.

TableChecks{cnt,1} = 'Check duplicated reactions';
method='FR';
removeFlag=0;
[modelOut,removedRxnInd, keptRxnInd] = checkDuplicateRxn(model,method,removeFlag,0);
if isempty(removedRxnInd)
    TableChecks{cnt,2} = 'No duplicated reactions in model.';
else
    TableChecks{cnt,2} = 'Duplicated reactions in model.';
end
cnt = cnt + 1;
%% 
% Check empty columns in 'model.rxnGeneMat'.

TableChecks{cnt,1} = 'Check empty columns in rxnGeneMat';
E = find(sum(model.rxnGeneMat)==0);
if isempty(E)
    TableChecks{cnt,2} = 'No empty columns in rxnGeneMat.';
else
    TableChecks{cnt,2} = 'Empty columns in rxnGeneMat.';
end
cnt = cnt + 1;
%% 
% Check that demand reactions have a lb >= 0.

TableChecks{cnt,1} = 'Check that demand reactions have a lb >= 0';
DMlb = find(model.lb(strmatch('DM_',model.rxns))<0);
if isempty(DMlb)
    TableChecks{cnt,2} = 'No demand reaction can have flux in backward direction.';
else
    TableChecks{cnt,2} = 'Demand reaction can have flux in backward direction.';
end
cnt = cnt + 1;
%% 
% Check whether singleGeneDeletion runs smoothly.

TableChecks{cnt,1} = 'Check whether singleGeneDeletion runs smoothly';
try
    [grRatio,grRateKO,grRateWT,hasEffect,delRxns,fluxSolution] = singleGeneDeletion(model);
    TableChecks{cnt,2} = 'singleGeneDeletion finished without problems.';
catch
    TableChecks{cnt,2} = 'There are problems with singleGeneDeletion.';
end
cnt = cnt + 1;
%% 
% Check for flux consistency.

TableChecks{cnt,1} = 'Check for flux consistency';
param.epsilon=1e-4;
param.modeFlag=0;
%param.method='null_fastcc';
param.method='fastcc';
printLevel = 1;
[fluxConsistentMetBool,fluxConsistentRxnBool,fluxInConsistentMetBool,fluxInConsistentRxnBool,model] = findFluxConsistentSubset(model,param,printLevel);
if isempty(find(fluxInConsistentRxnBool))
    TableChecks{cnt,2} = 'Model is flux consistent.';
else
    TableChecks{cnt,2} = 'Model is NOT flux consistent';
end
cnt = cnt + 1;
%% 
% Display all results.

TableChecks
%% 
% Save all results.

resultsFileName = 'TestResults';
save(strcat(resultsFileName,'.mat'));
%% References
%  [1] Brunk, E. et al. Recon 3D: A resource enabling a three-dimensional view 
% of gene variation in human metabolism. (submitted) 2017.
##### SOURCE END #####
--></body></html>
