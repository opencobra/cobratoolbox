name: Build and publish site (ordered)

on:
  push:
    branches:
      - master

permissions:
  contents: write

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

jobs:
  build-and-publish:
    name: Build, stage, and publish once
    runs-on: ubuntu-latest
    steps:
      # ==== Core documentation build ====
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: documentation/requirements.txt

      - name: Install documentation dependencies
        working-directory: ./documentation
        run: |
          pip install -r requirements.txt

      - name: Build documentation (Sphinx)
        working-directory: ./documentation
        run: |
          make html

      - name: Remove tutorials from build
        run: |
          rm -rf ./documentation/build/html/tutorials

      - name: Ensure staging directory
        run: |
          mkdir -p ghpages/stable

      - name: Remove Sphinx-generated contributors page
        run: |
          rm -f ./documentation/build/html/contributors.html

      - name: Stage core site to ghpages/stable
        run: |
          rsync -a --delete \
            ./documentation/build/html/ \
            ghpages/stable/

      # ==== Bring existing tutorials from gh-pages ====
      - name: Checkout gh-pages into temp dir (read-only)
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: ghpages-existing

      - name: Bring existing tutorials into staging (if present)
        run: |
          if [ -d ghpages-existing/stable/tutorials ]; then
            mkdir -p ghpages/stable/tutorials
            rsync -a ghpages-existing/stable/tutorials/ ghpages/stable/tutorials/
          else
            echo "No existing tutorials found on gh-pages; skipping copy."
          fi

      # ==== Function documentation ====
      - name: Generate publications rst file
        working-directory: ./documentation/source/sphinxext
        run: |
          python GenerateCitationsRST.py

      - name: Update packages
        working-directory: ./documentation/source
        run: |
          python ./sphinxext/copy_files.py

      - name: Generate functions rst files
        working-directory: ./documentation/source/modules
        run: |
          python ./GetRSTfiles.py

      - name: Generate documentation
        working-directory: ./documentation
        run: |
          make html

      - name: Copy the citations html page
        run: |
          mkdir -p ./documentation/source/Citations
          cp ./documentation/build/html/citations.html ./documentation/source/Citations/citations.html || true

      - name: Stage the function modules
        run: |
          mkdir -p ghpages/stable/modules
          rsync -a ./documentation/build/html/modules/ ghpages/stable/modules/

      - name: Stage the citations page
        run: |
          mkdir -p ghpages/stable
          rsync -a ./documentation/source/Citations/ ghpages/stable/

      - name: Stage the citations static page
        run: |
          mkdir -p ghpages/stable/_static
          rsync -a ./documentation/build/html/_static/ ghpages/stable/_static/

      # ==== Contributors page ====
      - name: Set up Python 3.10 (contributors)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: documentation/source/Contributions/requirements.txt

      - name: Install dependencies (contributors)
        working-directory: ./documentation/source/Contributions
        run: |
          pip install -r requirements.txt

      - name: Update contributors template sidebar from built index.html
        working-directory: ./documentation
        run: |
          python ./source/Contributions/UpdateSideBar.py \
          --source ./build/html/index.html \
          --input  ./source/Contributions/contributorsTemp.html \
          --output ./source/Contributions/contributorsTemp.html \
          --current-href contributors.html \
          --home-href index.html \
          --parser html5lib

      - name: Update Tutorials sidebar from built index.html
        working-directory: ./documentation
        run: |
          if [ -f ../ghpages/stable/tutorials/index.html ]; then
          python ./source/Contributions/UpdateSideBar.py \
            --source ./build/html/index.html \
            --input  ../ghpages/stable/tutorials/index.html \
            --output ../ghpages/stable/tutorials/index.html \
            --current-href tutorials/index.html \
            --home-href ../index.html \
            --href-prefix ../ \
            --parser html5lib
          else
            echo "No tutorials index found in staging; skipping sidebar update."
          fi

      - name: Update contributors
        working-directory: ./documentation/source/Contributions
        run: |
          python UpdateContributorsList.py

      - name: Generate HTML file
        working-directory: ./documentation/source/Contributions
        run: |
          python GenerateContributorsHTML.py

      - name: Stage contributors page to ghpages/stable
        run: |
          mkdir -p ghpages/stable
          rsync -a ./documentation/source/Contributions/contributors/ ghpages/stable/

      - name: Update static HTML copyrights
        working-directory: ./documentation
        run: |
          python ./source/Contributions/UpdateCopyright.py \
            ../ghpages/stable/contributors.html \
            ../ghpages/stable/tutorials/index.html || true

      # ==== Deploy to GitHub Pages ====
      - name: Deploy staged site to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ghpages
          branch: gh-pages
          clean: false
          commit-message: "Publish site (single deploy, ordered build)"
